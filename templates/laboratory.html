<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratory System - Healthcare Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Updated color scheme to match admin.html design system */
        :root {
            --primary: 168 85% 60%;
            --primary-foreground: 0 0% 100%;
            --secondary: 240 4% 16%;
            --secondary-foreground: 0 0% 100%;
            --accent: 142 71% 45%;
            --accent-foreground: 0 0% 100%;
            --background: 0 0% 7%;
            --foreground: 0 0% 98%;
            --card: 240 4% 10%;
            --card-foreground: 0 0% 98%;
            --border: 240 4% 16%;
            --muted: 240 4% 16%;
            --muted-foreground: 240 5% 65%;
        }
        
        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
        }

        /* Added layout structure matching admin.html */
        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between; /* Corrected from 'between' */
        }

        .gap-3 {
            gap: 0.75rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .px-6 {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }

        .py-4 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .p-6 {
            padding: 1.5rem;
        }

        .w-64 {
            width: 16rem;
        }

        .min-h-screen {
            min-height: 100vh;
        }

        .border-b {
            border-bottom: 1px solid hsl(var(--border));
        }

        .border-r {
            border-right: 1px solid hsl(var(--border));
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .w-10 {
            width: 2.5rem;
        }

        .h-10 {
            height: 2.5rem;
        }

        .w-6 {
            width: 1.5rem;
        }

        .h-6 {
            height: 1.5rem;
        }

        .w-5 {
            width: 1.25rem;
        }

        .h-5 {
            height: 1.25rem;
        }

        .text-xl {
            font-size: 1.25rem;
            line-height: 1.75rem;
        }

        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        
        .text-2xl {
            font-size: 1.5rem;
            line-height: 2rem;
        }

        .font-semibold {
            font-weight: 600;
        }
        
        .font-bold {
            font-weight: 700;
        }

        .flex-1 {
            flex: 1 1 0%;
        }

        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }
        
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }

        .hidden { display: none; }

        /* Updated card styles to match admin.html */
        .card {
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Updated button styles to match admin.html */
        .btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            border: 1px solid hsl(var(--border));
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn-secondary:hover {
            background-color: hsl(240 4% 20%);
        }
        
        .btn-danger {
            background-color: hsl(0 72% 51%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-success {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }

        /* Updated navigation styles to match admin.html */
        .nav-item {
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: hsl(var(--foreground));
        }
        
        .nav-item:hover {
            background-color: hsl(var(--secondary));
        }
        
        .nav-item.active {
            background-color: hsl(var(--secondary));
            color: hsl(var(--primary));
        }

        /* Section display logic */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 8px;
            padding: 1.5rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
        }

        /* Department cards */
        .dept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dept-card {
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .dept-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .dept-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .dept-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .dept-count {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
        }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background-color: hsl(var(--muted));
        }

        .table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 1px solid hsl(var(--border));
        }

        .table td {
            padding: 12px 16px;
            border-bottom: 1px solid hsl(var(--border));
            font-size: 0.875rem;
        }

        .table tbody tr:hover {
            background-color: hsl(var(--muted) / 0.5);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-pending {
            background-color: hsl(45 93% 47% / 0.2);
            color: hsl(45 93% 87%);
        }

        .badge-completed {
            background-color: hsl(var(--accent) / 0.2);
            color: hsl(var(--accent));
        }

        .badge-normal {
            background-color: hsl(var(--accent) / 0.2);
            color: hsl(var(--accent));
        }

        .badge-abnormal {
            background-color: hsl(0 72% 51% / 0.2);
            color: hsl(0 72% 71%);
        }

        .badge-available {
            background-color: hsl(var(--accent) / 0.2);
            color: hsl(var(--accent));
        }

        .badge-in-use {
            background-color: hsl(45 93% 47% / 0.2);
            color: hsl(45 93% 87%);
        }

        .badge-maintenance {
            background-color: hsl(0 72% 51% / 0.2);
            color: hsl(0 72% 71%);
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-size: 0.875rem;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: hsl(var(--primary));
        }

        .search-box {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-size: 0.875rem;
        }

        /* Test category styles */
        .test-category {
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .test-category-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .test-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .test-item {
            background-color: hsl(var(--muted));
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .section-subtitle {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
            margin-bottom: 2rem;
        }
        
        /* Added new styles for LIMS features */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: linear-gradient(135deg, hsl(var(--card)) 0%, hsl(240 4% 13%) 100%);
            border: 1px solid hsl(var(--border));
            border-radius: 8px;
            padding: 1.25rem;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .kpi-label {
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
        }

        .kpi-trend {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .trend-up { color: hsl(var(--accent)); }
        .trend-down { color: hsl(0 84% 60%); }

        .alert-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .alert-critical {
            background-color: hsl(0 84% 60% / 0.1);
            color: hsl(0 84% 60%);
            border: 1px solid hsl(0 84% 60% / 0.3);
        }

        .alert-warning {
            background-color: hsl(45 93% 60% / 0.1);
            color: hsl(45 93% 60%);
            border: 1px solid hsl(45 93% 60% / 0.3);
        }

        .alert-normal {
            background-color: hsl(var(--accent) / 0.1);
            color: hsl(var(--accent));
            border: 1px solid hsl(var(--accent) / 0.3);
        }

        .sample-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-received {
            background-color: hsl(45 93% 60% / 0.1);
            color: hsl(45 93% 60%);
        }

        .status-processing {
            background-color: hsl(168 85% 60% / 0.1);
            color: hsl(168 85% 60%);
        }

        .status-completed {
            background-color: hsl(var(--accent) / 0.1);
            color: hsl(var(--accent));
        }

        .status-verified {
            background-color: hsl(210 100% 60% / 0.1);
            color: hsl(210 100% 60%);
        }

        .qc-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .qc-pass { background-color: hsl(var(--accent)); }
        .qc-fail { background-color: hsl(0 84% 60%); }
        .qc-pending { background-color: hsl(45 93% 60%); }

        .chart-container {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            height: 200px;
            padding: 1rem 0;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .bar {
            width: 100%;
            background: linear-gradient(180deg, hsl(var(--primary)) 0%, hsl(var(--primary) / 0.6) 100%);
            border-radius: 4px 4px 0 0;
            transition: all 0.3s;
            position: relative;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .bar-label {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
            text-align: center;
        }

        .inventory-low {
            background-color: hsl(0 84% 60% / 0.05);
            border-left: 3px solid hsl(0 84% 60%);
        }

        .inventory-warning {
            background-color: hsl(45 93% 60% / 0.05);
            border-left: 3px solid hsl(45 93% 60%);
        }
        /* End of LIMS styles */
    </style>
</head>
<body>
    <!-- Header -->
    <header class="border-b" style="border-color: hsl(var(--border)); background-color: hsl(var(--card));">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background-color: hsl(var(--primary));">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-semibold">St. Andrew Hospital</h1>
                    <p class="text-sm" style="color: hsl(var(--muted-foreground));">Laboratory System</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span style="color: hsl(var(--muted-foreground));">Laboratory Staff: <span id="currentUserName">{{ user_info.full_name }}</span></span>
                <button class="btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 min-h-screen border-r p-4" style="border-color: hsl(var(--border)); background-color: hsl(var(--card));">
            <nav class="space-y-2">
                <div class="nav-item active" onclick="showSection('dashboard')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    Dashboard
                </div>
                <div class="nav-item" onclick="showSection('sample-management')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    Sample Management
                </div>
                <div class="nav-item" onclick="showSection('hematology')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Hematology
                </div>
                <div class="nav-item" onclick="showSection('chemistry')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    Clinical Chemistry
                </div>
                <div class="nav-item" onclick="showSection('microbiology')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                    </svg>
                    Microbiology
                </div>
                <div class="nav-item" onclick="showSection('equipment')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Equipment & QC
                </div>
                <div class="nav-item" onclick="showSection('inventory')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    Inventory & Reagents
                </div>
                <div class="nav-item" onclick="showSection('medical-records')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Medical Records
                </div>
                <div class="nav-item" onclick="showSection('reports')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Reports & Analytics
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6" style="background-color: hsl(var(--background));">
            
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section">
                <h2 class="text-2xl font-semibold mb-6">Laboratory Dashboard</h2>
                
                <!-- KPI Metrics -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Total Tests Today</div>
                        <div class="kpi-value" id="totalTests">0</div>
                        <div class="kpi-trend trend-up">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span id="testsTrend">+12%</span>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-label">Pending Results</div>
                        <div class="kpi-value" id="pendingTests">0</div>
                        <div class="kpi-trend">
                            <span id="pendingTrend">--</span>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-label">Critical Values</div>
                        <div class="kpi-value" style="color: hsl(0 84% 60%);" id="criticalValues">0</div>
                        <div class="kpi-trend">
                            <span id="criticalTrend">Requires attention</span>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-label">Equipment Status</div>
                        <div class="kpi-value" style="color: hsl(var(--accent));" id="activeEquipment">0</div>
                        <div class="kpi-trend">
                            <span id="equipmentStatus">All operational</span>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-label">Avg Turnaround Time</div>
                        <div class="kpi-value" style="font-size: 1.5rem;" id="avgTurnaround">2.4h</div>
                        <div class="kpi-trend trend-up">
                            <span>Improved 15min</span>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-label">QC Pass Rate</div>
                        <div class="kpi-value" style="color: hsl(var(--accent));" id="qcPassRate">98%</div>
                        <div class="kpi-trend trend-up">
                            <span>Within target</span>
                        </div>
                    </div>
                </div>

                <!-- Visual Analytics -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="chart-container">
                        <div class="chart-title">Daily Test Volume by Section</div>
                        <div class="bar-chart" id="testVolumeChart">
                            <div class="bar-item">
                                <div class="bar" style="height: 60%;">
                                    <span class="bar-value">45</span>
                                </div>
                                <div class="bar-label">Hematology</div>
                            </div>
                            <div class="bar-item">
                                <div class="bar" style="height: 80%;">
                                    <span class="bar-value">62</span>
                                </div>
                                <div class="bar-label">Chemistry</div>
                            </div>
                            <div class="bar-item">
                                <div class="bar" style="height: 40%;">
                                    <span class="bar-value">28</span>
                                </div>
                                <div class="bar-label">Microbiology</div>
                            </div>
                            <div class="bar-item">
                                <div class="bar" style="height: 30%;">
                                    <span class="bar-value">18</span>
                                </div>
                                <div class="bar-label">Others</div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Sample Status Overview</div>
                        <div style="padding: 1rem;">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <div class="qc-indicator" style="background-color: hsl(45 93% 60%);"></div>
                                    <span>Received</span>
                                </div>
                                <span class="font-semibold" id="receivedCount">23</span>
                            </div>
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <div class="qc-indicator" style="background-color: hsl(168 85% 60%);"></div>
                                    <span>Processing</span>
                                </div>
                                <span class="font-semibold" id="processingCount">15</span>
                            </div>
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <div class="qc-indicator qc-pass"></div>
                                    <span>Completed</span>
                                </div>
                                <span class="font-semibold" id="completedCount">87</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="qc-indicator" style="background-color: hsl(210 100% 60%);"></div>
                                    <span>Verified</span>
                                </div>
                                <span class="font-semibold" id="verifiedCount">74</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Critical Alerts -->
                <div class="card mb-6">
                    <div class="card-header">
                        <h3 class="card-title">Critical Value Alerts</h3>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th>Patient ID</th>
                                <th>Patient Name</th>
                                <th>Test</th>
                                <th>Value</th>
                                <th>Normal Range</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="criticalAlertsTable">
                            <tr>
                                <td colspan="8" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No critical alerts</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Recent Activities -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Test Activities</h3>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sample ID</th>
                                <th>Patient ID</th>
                                <th>Patient Name</th>
                                <th>Section</th>
                                <th>Test</th>
                                <th>Status</th>
                                <th>Tested By</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivitiesTable">
                            <tr>
                                <td colspan="8" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No recent activities</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Sample Management Section -->
            <section id="sample-management" class="content-section hidden">
                <h2 class="text-2xl font-semibold mb-6">Sample Management & Tracking</h2>
                
                <div class="card mb-6">
                    <h3 class="text-lg font-semibold mb-4">Register New Sample</h3>
                    <form id="sampleForm" onsubmit="registerSample(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Patient ID *</label>
                                <input type="text" class="form-input" name="sampleId" required placeholder="Auto-generated">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Patient Name *</label>
                                <input type="text" class="form-input" name="patientName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sample Type *</label>
                                <select class="form-select" name="sampleType" required>
                                    <option value="">Select type</option>
                                    <option value="Blood">Blood</option>
                                    <option value="Urine">Urine</option>
                                    <option value="Stool">Stool</option>
                                    <option value="Sputum">Sputum</option>
                                    <option value="CSF">CSF</option>
                                    <option value="Tissue">Tissue</option>
                                    <option value="Swab">Swab</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Laboratory Section *</label>
                                <select class="form-select" name="section" required>
                                    <option value="">Select section</option>
                                    <option value="Hematology">Hematology</option>
                                    <option value="Clinical Chemistry">Clinical Chemistry</option>
                                    <option value="Microbiology">Microbiology</option>
                                    <option value="Parasitology">Parasitology</option>
                                    <option value="Urinalysis">Urinalysis</option>
                                    <option value="Blood Bank">Blood Bank</option>
                                    <option value="Serology">Serology</option>
                                    <option value="Histopathology">Histopathology</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Collection Time *</label>
                                <input type="datetime-local" class="form-input" name="collectionTime" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Test Requested *</label>
                            <input type="text" class="form-input" name="testRequested" required placeholder="e.g., CBC, FBS, Blood Culture">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Clinical Notes</label>
                            <textarea class="form-textarea" name="clinicalNotes" placeholder="Any relevant clinical information"></textarea>
                        </div>
                        <button type="submit" class="btn-primary">Register Sample</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Sample Tracking</h3>
                        <div class="flex gap-2">
                            <input type="text" id="sampleSearch" class="form-input" placeholder="Search by Sample ID or Patient ID" style="width: 300px;">
                            <button class="btn-secondary" onclick="searchSamples()">Search</button>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sample ID</th>
                                <th>Patient ID</th>
                                <th>Patient Name</th>
                                <th>Type</th>
                                <th>Section</th>
                                <th>Test</th>
                                <th>Status</th>
                                <th>Received By</th>
                                <th>Timestamp</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="samplesTable">
                            <tr>
                                <td colspan="10" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No samples registered</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Hematology Section -->
            <div id="hematology" class="content-section hidden">
                <h2 class="section-title">Hematology Section</h2>
                <p class="section-subtitle">Blood cell analysis and coagulation studies</p>

                <div class="test-category">
                    <div class="test-category-title">Available Tests</div>
                    <div class="test-items">
                        <div class="test-item">Complete Blood Count (CBC)</div>
                        <div class="test-item">Hemoglobin (Hgb)</div>
                        <div class="test-item">Hematocrit (Hct)</div>
                        <div class="test-item">Platelet Count</div>
                        <div class="test-item">PT (Prothrombin Time)</div>
                        <div class="test-item">PTT (Partial Thromboplastin Time)</div>
                        <div class="test-item">Blood Smear Examination</div>
                        <div class="test-item">Reticulocyte Count</div>
                        <div class="test-item">ESR (Erythrocyte Sedimentation Rate)</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1.5rem; font-size: 1.125rem; font-weight: 600;">Enter Hematology Results</h3>
                    <form id="hematologyForm" onsubmit="submitHematologyTest(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Patient ID *</label>
                                <input type="text" class="form-input" name="patientId" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Patient Name *</label>
                                <input type="text" class="form-input" name="patientName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Test Name *</label>
                                <select class="form-select" name="testName" required>
                                    <option value="CBC">Complete Blood Count (CBC)</option>
                                    <option value="Hemoglobin">Hemoglobin</option>
                                    <option value="Hematocrit">Hematocrit</option>
                                    <option value="Platelet Count">Platelet Count</option>
                                    <option value="PT">Prothrombin Time (PT)</option>
                                    <option value="PTT">Partial Thromboplastin Time (PTT)</option>
                                    <option value="Blood Smear">Blood Smear</option>
                                    <option value="ESR">ESR</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">WBC Count (x10³/μL)</label>
                                <input type="text" class="form-input" name="wbc" placeholder="Normal: 4.5-11.0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">RBC Count (x10⁶/μL)</label>
                                <input type="text" class="form-input" name="rbc" placeholder="M: 4.5-5.5, F: 4.0-5.0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hemoglobin (g/dL)</label>
                                <input type="text" class="form-input" name="hemoglobin" placeholder="M: 13-15.5, F: 12-14.5">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hematocrit (%)</label>
                                <input type="text" class="form-input" name="hematocrit" placeholder="M: 40-48, F: 36-44">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Platelet Count (x10³/μL)</label>
                                <input type="text" class="form-input" name="platelet" placeholder="150-450">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Equipment Used</label>
                                <select class="form-select" name="equipment">
                                    <option value="Hematology Analyzer">Hematology Analyzer</option>
                                    <option value="Manual Count">Manual Count</option>
                                    <option value="Microscope">Microscope</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Remarks / Interpretation</label>
                            <textarea class="form-textarea" name="remarks"></textarea>
                        </div>
                        <button type="submit" class="btn-primary">Submit Results</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Hematology Results</h3>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Patient ID</th>
                                <th>Patient Name</th>
                                <th>Test</th>
                                <th>Results</th>
                                <th>Tested By</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hematologyTable">
                            <tr>
                                <td colspan="7" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No test results yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Clinical Chemistry Section -->
            <div id="chemistry" class="content-section hidden">
                <h2 class="section-title">Clinical Chemistry Section</h2>
                <p class="section-subtitle">Metabolic and organ function tests</p>

                <div class="test-category">
                    <div class="test-category-title">Available Tests</div>
                    <div class="test-items">
                        <div class="test-item">FBS (Fasting Blood Sugar)</div>
                        <div class="test-item">RBS (Random Blood Sugar)</div>
                        <div class="test-item">HbA1c</div>
                        <div class="test-item">Total Cholesterol</div>
                        <div class="test-item">Triglycerides</div>
                        <div class="test-item">HDL / LDL</div>
                        <div class="test-item">ALT (SGPT)</div>
                        <div class="test-item">AST (SGOT)</div>
                        <div class="test-item">Creatinine</div>
                        <div class="test-item">BUN (Blood Urea Nitrogen)</div>
                        <div class="test-item">Uric Acid</div>
                        <div class="test-item">Electrolytes (Na, K, Cl)</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1.5rem; font-size: 1.125rem; font-weight: 600;">Enter Chemistry Results</h3>
                    <form id="chemistryForm" onsubmit="submitChemistryTest(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Patient ID *</label>
                                <input type="text" class="form-input" name="patientId" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Patient Name *</label>
                                <input type="text" class="form-input" name="patientName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Test Panel *</label>
                                <select class="form-select" name="testName" required>
                                    <option value="Blood Sugar">Blood Sugar Tests</option>
                                    <option value="Lipid Profile">Lipid Profile</option>
                                    <option value="Liver Function">Liver Function Tests</option>
                                    <option value="Kidney Function">Kidney Function Tests</option>
                                    <option value="Electrolytes">Electrolytes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">FBS (mg/dL)</label>
                                <input type="text" class="form-input" name="fbs" placeholder="Normal: 70-100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cholesterol (mg/dL)</label>
                                <input type="text" class="form-input" name="cholesterol" placeholder="Normal: <200">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Triglycerides (mg/dL)</label>
                                <input type="text" class="form-input" name="triglycerides" placeholder="Normal: <150">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Creatinine (mg/dL)</label>
                                <input type="text" class="form-input" name="creatinine" placeholder="M: 0.7-1.3, F: 0.6-1.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ALT/SGPT (U/L)</label>
                                <input type="text" class="form-input" name="alt" placeholder="Normal: 7-56">
                            </div>
                            <div class="form-group">
                                <label class="form-label">AST/SGOT (U/L)</label>
                                <input type="text" class="form-input" name="ast" placeholder="Normal: 10-40">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Equipment Used</label>
                                <select class="form-select" name="equipment">
                                    <option value="Chemistry Analyzer">Chemistry Analyzer</option>
                                    <option value="Spectrophotometer">Spectrophotometer</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Clinical Interpretation</label>
                            <textarea class="form-textarea" name="remarks"></textarea>
                        </div>
                        <button type="submit" class="btn-primary">Submit Results</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Chemistry Results</h3>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Patient ID</th>
                                <th>Patient Name</th>
                                <th>Test Panel</th>
                                <th>Key Results</th>
                                <th>Tested By</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="chemistryTable">
                            <tr>
                                <td colspan="7" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No test results yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Microbiology Section -->
            <div id="microbiology" class="content-section hidden">
                <h2 class="section-title">Microbiology Section</h2>
                <p class="section-subtitle">Culture and sensitivity testing</p>

                <div class="test-category">
                    <div class="test-category-title">Available Tests</div>
                    <div class="test-items">
                        <div class="test-item">Urine Culture</div>
                        <div class="test-item">Stool Culture</div>
                        <div class="test-item">Sputum Culture</div>
                        <div class="test-item">Blood Culture</div>
                        <div class="test-item">Throat Swab Culture</div>
                        <div class="test-item">Wound Swab Culture</div>
                        <div class="test-item">Antibiotic Sensitivity Test (AST)</div>
                        <div class="test-item">Gram Stain</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1.5rem; font-size: 1.125rem; font-weight: 600;">Enter Microbiology Results</h3>
                    <form id="microbiologyForm" onsubmit="submitMicrobiologyTest(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Patient ID *</label>
                                <input type="text" class="form-input" name="patientId" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Patient Name *</label>
                                <input type="text" class="form-input" name="patientName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Culture Type *</label>
                                <select class="form-select" name="testName" required>
                                    <option value="Urine Culture">Urine Culture</option>
                                    <option value="Stool Culture">Stool Culture</option>
                                    <option value="Sputum Culture">Sputum Culture</option>
                                    <option value="Blood Culture">Blood Culture</option>
                                    <option value="Swab Culture">Swab Culture</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gram Stain Result</label>
                                <select class="form-select" name="gramStain">
                                    <option value="Gram Positive">Gram Positive</option>
                                    <option value="Gram Negative">Gram Negative</option>
                                    <option value="No Organism Seen">No Organism Seen</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Organism Identified</label>
                                <input type="text" class="form-input" name="organism" placeholder="e.g., E. coli">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Colony Count</label>
                                <input type="text" class="form-input" name="colonyCount" placeholder="e.g., >100,000 CFU/mL">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Culture Result</label>
                                <select class="form-select" name="cultureResult">
                                    <option value="No Growth">No Growth</option>
                                    <option value="Light Growth">Light Growth</option>
                                    <option value="Moderate Growth">Moderate Growth</option>
                                    <option value="Heavy Growth">Heavy Growth</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Incubation Period</label>
                                <input type="text" class="form-input" name="incubation" placeholder="e.g., 24-48 hours">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Antibiotic Sensitivity (AST)</label>
                            <textarea class="form-textarea" name="sensitivity" placeholder="List sensitive and resistant antibiotics"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Remarks</label>
                            <textarea class="form-textarea" name="remarks"></textarea>
                        </div>
                        <button type="submit" class="btn-primary">Submit Results</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Microbiology Results</h3>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Patient ID</th>
                                <th>Patient Name</th>
                                <th>Culture Type</th>
                                <th>Organism</th>
                                <th>Result</th>
                                <th>Tested By</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="microbiologyTable">
                            <tr>
                                <td colspan="8" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No test results yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Equipment & QC Section -->
            <section id="equipment" class="content-section hidden">
                <h2 class="text-2xl font-semibold mb-6">Equipment Management & Quality Control</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span style="color: hsl(var(--muted-foreground));">Total Equipment</span>
                            <svg class="w-5 h-5" style="color: hsl(var(--primary));" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="totalEquipmentCount">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span style="color: hsl(var(--muted-foreground));">Due for Calibration</span>
                            <svg class="w-5 h-5" style="color: hsl(45 93% 60%);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" style="color: hsl(45 93% 60%);" id="dueCalibrationCount">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span style="color: hsl(var(--muted-foreground));">QC Tests Today</span>
                            <svg class="w-5 h-5" style="color: hsl(var(--accent));" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="qcTestsCount">0</div>
                    </div>
                </div>

                <div class="card mb-6">
                    <h3 class="text-lg font-semibold mb-4">Register Equipment</h3>
                    <form id="equipmentForm" onsubmit="registerEquipment(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Equipment Name *</label>
                                <input type="text" class="form-input" name="name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Serial Number *</label>
                                <input type="text" class="form-input" name="serialNumber" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Manufacturer *</label>
                                <input type="text" class="form-input" name="manufacturer" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Model *</label>
                                <input type="text" class="form-input" name="model" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Purchase Date</label>
                                <input type="date" class="form-input" name="purchaseDate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Calibration</label>
                                <input type="date" class="form-input" name="lastCalibration">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Next Calibration *</label>
                                <input type="date" class="form-input" name="nextCalibration" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status *</label>
                                <select class="form-select" name="status" required>
                                    <option value="Operational">Operational</option>
                                    <option value="Maintenance">Under Maintenance</option>
                                    <option value="Calibration">Needs Calibration</option>
                                    <option value="Down">Out of Service</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">Register Equipment</button>
                    </form>
                </div>

                <div class="card mb-6">
                    <div class="card-header">
                        <h3 class="card-title">Daily Quality Control Log</h3>
                    </div>
                    <form id="qcForm" onsubmit="submitQC(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Equipment *</label>
                                <select class="form-select" name="equipment" id="qcEquipmentSelect" required>
                                    <option value="">Select equipment</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">QC Test Type *</label>
                                <select class="form-select" name="qcType" required>
                                    <option value="Level 1">Level 1 Control</option>
                                    <option value="Level 2">Level 2 Control</option>
                                    <option value="Level 3">Level 3 Control</option>
                                    <option value="Calibration">Calibration Verification</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Expected Value *</label>
                                <input type="text" class="form-input" name="expectedValue" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Observed Value *</label>
                                <input type="text" class="form-input" name="observedValue" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Result *</label>
                                <select class="form-select" name="result" required>
                                    <option value="Pass">Pass</option>
                                    <option value="Fail">Fail</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" name="notes" placeholder="Any observations or corrective actions"></textarea>
                        </div>
                        <button type="submit" class="btn-primary">Submit QC Result</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Equipment Inventory</h3>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Serial Number</th>
                                <th>Manufacturer</th>
                                <th>Model</th>
                                <th>Last Calibration</th>
                                <th>Next Calibration</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="equipmentTable">
                            <tr>
                                <td colspan="8" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No equipment registered</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Inventory Section -->
            <section id="inventory" class="content-section hidden">
                <h2 class="text-2xl font-semibold mb-6">Inventory & Reagent Management</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span style="color: hsl(var(--muted-foreground));">Total Items</span>
                            <svg class="w-5 h-5" style="color: hsl(var(--primary));" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="totalInventoryCount">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span style="color: hsl(var(--muted-foreground));">Low Stock Alerts</span>
                            <svg class="w-5 h-5" style="color: hsl(0 84% 60%);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" style="color: hsl(0 84% 60%);" id="lowStockCount">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span style="color: hsl(var(--muted-foreground));">Expiring Soon</span>
                            <svg class="w-5 h-5" style="color: hsl(45 93% 60%);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" style="color: hsl(45 93% 60%);" id="expiringSoonCount">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span style="color: hsl(var(--muted-foreground));">Total Value</span>
                            <svg class="w-5 h-5" style="color: hsl(var(--accent));" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="totalInventoryValue">$0</div>
                    </div>
                </div>

                <div class="card mb-6">
                    <h3 class="text-lg font-semibold mb-4">Add Reagent / Supply</h3>
                    <form id="inventoryForm" onsubmit="addInventoryItem(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Item Name *</label>
                                <input type="text" class="form-input" name="itemName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Category *</label>
                                <select class="form-select" name="category" required>
                                    <option value="">Select category</option>
                                    <option value="Reagent">Reagent</option>
                                    <option value="Control">Quality Control Material</option>
                                    <option value="Consumable">Consumable</option>
                                    <option value="Chemical">Chemical</option>
                                    <option value="Media">Culture Media</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lot Number *</label>
                                <input type="text" class="form-input" name="lotNumber" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantity *</label>
                                <input type="number" class="form-input" name="quantity" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unit *</label>
                                <select class="form-select" name="unit" required>
                                    <option value="mL">mL</option>
                                    <option value="L">L</option>
                                    <option value="mg">mg</option>
                                    <option value="g">g</option>
                                    <option value="pcs">Pieces</option>
                                    <option value="box">Box</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reorder Level *</label>
                                <input type="number" class="form-input" name="reorderLevel" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Expiration Date *</label>
                                <input type="date" class="form-input" name="expirationDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unit Price</label>
                                <input type="number" step="0.01" class="form-input" name="unitPrice" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Supplier</label>
                                <input type="text" class="form-input" name="supplier">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">Add Item</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Inventory List</h3>
                        <div class="flex gap-2">
                            <select id="inventoryCategoryFilter" class="form-select" onchange="filterInventory()" style="width: 200px;">
                                <option value="">All Categories</option>
                                <option value="Reagent">Reagent</option>
                                <option value="Control">Quality Control</option>
                                <option value="Consumable">Consumable</option>
                                <option value="Chemical">Chemical</option>
                                <option value="Media">Culture Media</option>
                            </select>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Lot Number</th>
                                <th>Quantity</th>
                                <th>Reorder Level</th>
                                <th>Expiration Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable">
                            <tr>
                                <td colspan="8" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No items in inventory</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Medical Records Section -->
            <div id="medical-records" class="content-section hidden">
                <h2 class="section-title">Medical Records</h2>
                <p class="section-subtitle">View and manage patient historical data</p>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Patient Search</h3>
                        <input type="text" id="patientSearch" class="search-box" placeholder="Search by Patient ID or Name">
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Patient ID</th>
                                <th>Patient Name</th>
                                <th>Date of Birth</th>
                                <th>Contact</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="medicalRecordsTable">
                            <tr>
                                <td colspan="5" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No patient records found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports" class="content-section hidden">
                <h2 class="section-title">Laboratory Reports</h2>
                <p class="section-subtitle">Statistical analysis and reporting</p>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #dbeafe; color: #1e40af;">📊</div>
                        <div class="stat-value" id="monthlyTests">0</div>
                        <div class="stat-label">Tests This Month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #d1fae5; color: #065f46;">✅</div>
                        <div class="stat-value" id="normalResults">0</div>
                        <div class="stat-label">Normal Results</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #fee2e2; color: #991b1b;">⚠️</div>
                        <div class="stat-value" id="abnormalResults">0</div>
                        <div class="stat-label">Abnormal Results</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #fef3c7; color: #92400e;">⚙️</div>
                        <div class="stat-value" id="equipmentUsageRate">0%</div>
                        <div class="stat-label">Equipment Usage Rate</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Test Summary by Type</h3>
                        <button class="btn-primary" onclick="generateFullReport()">Generate Report</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Test Type</th>
                                <th>Total Count</th>
                                <th>Normal</th>
                                <th>Abnormal</th>
                                <th>Pending</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTable">
                            <tr>
                                <td colspan="5" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize lab staff
        const labStaff = {
            id: 'LS001',
            name: '{{ user_info.full_name }}', // Dynamic name from session
            role: '{{ user_info.role }}'
        };

        // Check session and initialize
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/check-session');
                const data = await response.json();
                
                if (!data.authenticated) {
                    window.location.href = '/IMS';
                    return;
                }
                
                // Update staff info
                labStaff.name = data.full_name;
                document.getElementById('currentUserName').textContent = data.full_name;
                
                // Continue with existing initialization
                updateDashboard();
                loadSamples();
                loadEquipment();
                loadInventory();
                populateQCEquipment();
                loadHematologyTests();
                loadChemistryTests();
                loadMicrobiologyTests();
                
                // Set the initial active section
                showSection('dashboard');
            } catch (error) {
                console.error('Session check error:', error);
                window.location.href = '/IMS';
            }
        });

        // Initialize localStorage
        if (!localStorage.getItem('labTests')) {
            localStorage.setItem('labTests', JSON.stringify([]));
        }
        if (!localStorage.getItem('equipment')) {
            localStorage.setItem('equipment', JSON.stringify([]));
        }
        if (!localStorage.getItem('samples')) {
            localStorage.setItem('samples', JSON.stringify([]));
        }
        if (!localStorage.getItem('inventory')) {
            localStorage.setItem('inventory', JSON.stringify([]));
        }
        if (!localStorage.getItem('qcLogs')) {
            localStorage.setItem('qcLogs', JSON.stringify([]));
        }

        function registerSample(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const sampleData = {
                id: Date.now(),
                sampleId: formData.get('sampleId') || `SMP${Date.now()}`,
                patientId: formData.get('patientId'),
                patientName: formData.get('patientName'),
                sampleType: formData.get('sampleType'),
                section: formData.get('section'),
                testRequested: formData.get('testRequested'),
                collectionTime: formData.get('collectionTime'),
                clinicalNotes: formData.get('clinicalNotes'),
                status: 'Received',
                receivedBy: labStaff.name,
                timestamp: new Date().toISOString()
            };

            const samples = JSON.parse(localStorage.getItem('samples')) || [];
            samples.push(sampleData);
            localStorage.setItem('samples', JSON.stringify(samples));
            
            alert('Sample registered successfully!');
            event.target.reset();
            loadSamples();
            updateDashboard();
        }

        function loadSamples() {
            const samples = JSON.parse(localStorage.getItem('samples')) || [];
            const tbody = document.getElementById('samplesTable');
            
            if (samples.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No samples registered</td></tr>';
                return;
            }
            
            tbody.innerHTML = samples.slice(-50).reverse().map(sample => `
                <tr>
                    <td><strong>${sample.sampleId}</strong></td>
                    <td>${sample.patientId}</td>
                    <td>${sample.patientName}</td>
                    <td>${sample.sampleType}</td>
                    <td>${sample.section}</td>
                    <td>${sample.testRequested}</td>
                    <td><span class="sample-status status-${sample.status.toLowerCase()}">${sample.status}</span></td>
                    <td>${sample.receivedBy}</td>
                    <td>${new Date(sample.timestamp).toLocaleString()}</td>
                    <td>
                        <button class="btn-secondary" onclick="updateSampleStatus(${sample.id}, 'Processing')">Process</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateSampleStatus(sampleId, newStatus) {
            const samples = JSON.parse(localStorage.getItem('samples')) || [];
            const sample = samples.find(s => s.id === sampleId);
            if (sample) {
                sample.status = newStatus;
                localStorage.setItem('samples', JSON.stringify(samples));
                loadSamples();
                updateDashboard();
            }
        }

        function searchSamples() {
            const searchTerm = document.getElementById('sampleSearch').value.toLowerCase();
            const samples = JSON.parse(localStorage.getItem('samples')) || [];
            const filtered = samples.filter(s => 
                s.sampleId.toLowerCase().includes(searchTerm) || 
                s.patientId.toLowerCase().includes(searchTerm)
            );
            
            const tbody = document.getElementById('samplesTable');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No samples found</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(sample => `
                <tr>
                    <td><strong>${sample.sampleId}</strong></td>
                    <td>${sample.patientId}</td>
                    <td>${sample.patientName}</td>
                    <td>${sample.sampleType}</td>
                    <td>${sample.section}</td>
                    <td>${sample.testRequested}</td>
                    <td><span class="sample-status status-${sample.status.toLowerCase()}">${sample.status}</span></td>
                    <td>${sample.receivedBy}</td>
                    <td>${new Date(sample.timestamp).toLocaleString()}</td>
                    <td>
                        <button class="btn-secondary" onclick="updateSampleStatus(${sample.id}, 'Processing')">Process</button>
                    </td>
                </tr>
            `).join('');
        }

        function submitQC(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const qcData = {
                id: Date.now(),
                equipment: formData.get('equipment'),
                qcType: formData.get('qcType'),
                expectedValue: formData.get('expectedValue'),
                observedValue: formData.get('observedValue'),
                result: formData.get('result'),
                notes: formData.get('notes'),
                performedBy: labStaff.name,
                timestamp: new Date().toISOString()
            };

            const qcLogs = JSON.parse(localStorage.getItem('qcLogs')) || [];
            qcLogs.push(qcData);
            localStorage.setItem('qcLogs', JSON.stringify(qcLogs));
            
            alert('QC result submitted successfully!');
            event.target.reset();
            updateDashboard();
        }

        function registerEquipment(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const equipmentData = {
                id: Date.now(),
                name: formData.get('name'),
                serialNumber: formData.get('serialNumber'),
                manufacturer: formData.get('manufacturer'),
                model: formData.get('model'),
                purchaseDate: formData.get('purchaseDate'),
                lastCalibration: formData.get('lastCalibration'),
                nextCalibration: formData.get('nextCalibration'),
                status: formData.get('status')
            };

            const equipment = JSON.parse(localStorage.getItem('equipment')) || [];
            equipment.push(equipmentData);
            localStorage.setItem('equipment', JSON.stringify(equipment));
            
            alert('Equipment registered successfully!');
            event.target.reset();
            loadEquipment();
            populateQCEquipment();
            updateDashboard();
        }

        function loadEquipment() {
            const equipment = JSON.parse(localStorage.getItem('equipment')) || [];
            const tbody = document.getElementById('equipmentTable');
            
            if (equipment.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No equipment registered</td></tr>';
                return;
            }
            
            tbody.innerHTML = equipment.map(eq => `
                <tr>
                    <td>${eq.name}</td>
                    <td>${eq.serialNumber}</td>
                    <td>${eq.manufacturer}</td>
                    <td>${eq.model}</td>
                    <td>${eq.lastCalibration || 'N/A'}</td>
                    <td>${eq.nextCalibration}</td>
                    <td><span class="badge badge-${eq.status === 'Operational' ? 'success' : 'warning'}">${eq.status}</span></td>
                    <td>
                        <button class="btn-secondary" onclick="deleteEquipment(${eq.id})">Delete</button>
                    </td>
                </tr>
            `).join('');

            // Update calibration count
            const today = new Date();
            const dueCalibration = equipment.filter(eq => {
                const nextCal = new Date(eq.nextCalibration);
                const daysUntil = Math.ceil((nextCal - today) / (1000 * 60 * 60 * 24));
                return daysUntil <= 30;
            }).length;
            document.getElementById('dueCalibrationCount').textContent = dueCalibration;
            document.getElementById('totalEquipmentCount').textContent = equipment.length;
        }

        function populateQCEquipment() {
            const equipment = JSON.parse(localStorage.getItem('equipment')) || [];
            const select = document.getElementById('qcEquipmentSelect');
            select.innerHTML = '<option value="">Select equipment</option>' + 
                equipment.map(eq => `<option value="${eq.name}">${eq.name}</option>`).join('');
        }

        function addInventoryItem(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const quantity = parseFloat(formData.get('quantity'));
            const unitPrice = parseFloat(formData.get('unitPrice')) || 0;
            
            const inventoryData = {
                id: Date.now(),
                itemName: formData.get('itemName'),
                category: formData.get('category'),
                lotNumber: formData.get('lotNumber'),
                quantity: quantity,
                unit: formData.get('unit'),
                reorderLevel: parseFloat(formData.get('reorderLevel')),
                expirationDate: formData.get('expirationDate'),
                unitPrice: unitPrice,
                totalValue: quantity * unitPrice,
                supplier: formData.get('supplier'),
                addedBy: labStaff.name,
                timestamp: new Date().toISOString()
            };

            const inventory = JSON.parse(localStorage.getItem('inventory')) || [];
            inventory.push(inventoryData);
            localStorage.setItem('inventory', JSON.stringify(inventory));
            
            alert('Item added to inventory successfully!');
            event.target.reset();
            loadInventory();
            updateDashboard();
        }

        function loadInventory() {
            const inventory = JSON.parse(localStorage.getItem('inventory')) || [];
            const tbody = document.getElementById('inventoryTable');
            
            if (inventory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No items in inventory</td></tr>';
                return;
            }
            
            const today = new Date();
            
            tbody.innerHTML = inventory.map(item => {
                const expiryDate = new Date(item.expirationDate);
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                const isLowStock = item.quantity <= item.reorderLevel;
                const isExpiringSoon = daysUntilExpiry <= 30 && daysUntilExpiry > 0;
                const isExpired = daysUntilExpiry <= 0;
                
                let statusBadge = '';
                let rowClass = '';
                
                if (isExpired) {
                    statusBadge = '<span class="alert-badge alert-critical">Expired</span>';
                    rowClass = 'inventory-low';
                } else if (isLowStock) {
                    statusBadge = '<span class="alert-badge alert-critical">Low Stock</span>';
                    rowClass = 'inventory-low';
                } else if (isExpiringSoon) {
                    statusBadge = '<span class="alert-badge alert-warning">Expiring Soon</span>';
                    rowClass = 'inventory-warning';
                } else {
                    statusBadge = '<span class="alert-badge alert-normal">Normal</span>';
                }
                
                return `
                    <tr class="${rowClass}">
                        <td>${item.itemName}</td>
                        <td>${item.category}</td>
                        <td>${item.lotNumber}</td>
                        <td>${item.quantity} ${item.unit}</td>
                        <td>${item.reorderLevel} ${item.unit}</td>
                        <td>${item.expirationDate}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn-secondary" onclick="deleteInventoryItem(${item.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update inventory stats
            const lowStock = inventory.filter(item => item.quantity <= item.reorderLevel).length;
            const expiringSoon = inventory.filter(item => {
                const expiryDate = new Date(item.expirationDate);
                const daysUntil = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                return daysUntil <= 30 && daysUntil > 0;
            }).length;
            const totalValue = inventory.reduce((sum, item) => sum + (item.totalValue || 0), 0);
            
            document.getElementById('totalInventoryCount').textContent = inventory.length;
            document.getElementById('lowStockCount').textContent = lowStock;
            document.getElementById('expiringSoonCount').textContent = expiringSoon;
            document.getElementById('totalInventoryValue').textContent = `$${totalValue.toFixed(2)}`;
        }

        function filterInventory() {
            const category = document.getElementById('inventoryCategoryFilter').value;
            const inventory = JSON.parse(localStorage.getItem('inventory')) || [];
            const filtered = category ? inventory.filter(item => item.category === category) : inventory;
            
            // Re-render with filtered data (simplified version)
            loadInventory();
        }

        function deleteInventoryItem(itemId) {
            if (confirm('Are you sure you want to delete this item?')) {
                let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
                inventory = inventory.filter(item => item.id !== itemId);
                localStorage.setItem('inventory', JSON.stringify(inventory));
                loadInventory();
                updateDashboard();
            }
        }

        function updateDashboard() {
            const tests = JSON.parse(localStorage.getItem('labTests')) || [];
            const equipment = JSON.parse(localStorage.getItem('equipment')) || [];
            const samples = JSON.parse(localStorage.getItem('samples')) || [];
            const qcLogs = JSON.parse(localStorage.getItem('qcLogs')) || [];
            
            const today = new Date().toDateString();
            const todayTests = tests.filter(test => new Date(test.date).toDateString() === today);
            const todayQC = qcLogs.filter(qc => new Date(qc.timestamp).toDateString() === today);
            
            // Update KPIs
            document.getElementById('totalTests').textContent = todayTests.length;
            document.getElementById('pendingTests').textContent = tests.filter(t => t.status === 'Pending').length;
            document.getElementById('activeEquipment').textContent = equipment.filter(e => e.status === 'Operational').length;
            document.getElementById('qcTestsCount').textContent = todayQC.length;
            
            // Calculate QC pass rate
            const qcPassRate = todayQC.length > 0 ? 
                Math.round((todayQC.filter(qc => qc.result === 'Pass').length / todayQC.length) * 100) : 0;
            document.getElementById('qcPassRate').textContent = `${qcPassRate}%`;
            
            // Update sample status counts
            document.getElementById('receivedCount').textContent = samples.filter(s => s.status === 'Received').length;
            document.getElementById('processingCount').textContent = samples.filter(s => s.status === 'Processing').length;
            document.getElementById('completedCount').textContent = samples.filter(s => s.status === 'Completed').length;
            document.getElementById('verifiedCount').textContent = samples.filter(s => s.status === 'Verified').length;
            
            // Critical values (simulated - would need actual test result thresholds in production)
            const criticalTests = tests.filter(t => {
                // Example: check if any values are outside critical ranges
                return (t.hemoglobin && parseFloat(t.hemoglobin) < 7) || 
                       (t.platelet && parseFloat(t.platelet) < 50);
            });
            document.getElementById('criticalValues').textContent = criticalTests.length;
            
            // Load critical alerts table
            loadCriticalAlerts(criticalTests);
            
            // Load recent activities
            loadRecentActivities(tests);
        }

        function loadCriticalAlerts(criticalTests) {
            const tbody = document.getElementById('criticalAlertsTable');
            
            if (criticalTests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No critical alerts</td></tr>';
                return;
            }
            
            tbody.innerHTML = criticalTests.slice(-10).reverse().map(test => `
                <tr>
                    <td><span class="alert-badge alert-critical">CRITICAL</span></td>
                    <td>${test.patientId}</td>
                    <td>${test.patientName}</td>
                    <td>${test.testName}</td>
                    <td><strong>${test.hemoglobin || test.platelet}</strong></td>
                    <td>7-17 g/dL</td>
                    <td>${new Date(test.date).toLocaleTimeString()}</td>
                    <td><button class="btn-primary">Notify</button></td>
                </tr>
            `).join('');
        }

        function loadRecentActivities(tests) {
            const recentTests = tests.slice(-10).reverse();
            const tbody = document.getElementById('recentActivitiesTable');
            
            if (recentTests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No recent activities</td></tr>';
                return;
            }
            
            tbody.innerHTML = recentTests.map(test => `
                <tr>
                    <td>SMP${test.id}</td>
                    <td>${test.patientId}</td>
                    <td>${test.patientName}</td>
                    <td>${test.section}</td>
                    <td>${test.testName}</td>
                    <td><span class="badge badge-${test.status === 'Completed' ? 'success' : 'warning'}">${test.status}</span></td>
                    <td>${test.testedBy}</td>
                    <td>${new Date(test.date).toLocaleString()}</td>
                </tr>
            `).join('');
        }

        // Submit Hematology Test
        function submitHematologyTest(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const testData = {
                id: Date.now(),
                section: 'Hematology',
                patientId: formData.get('patientId'),
                patientName: formData.get('patientName'),
                testName: formData.get('testName'),
                wbc: formData.get('wbc'),
                rbc: formData.get('rbc'),
                hemoglobin: formData.get('hemoglobin'),
                hematocrit: formData.get('hematocrit'),
                platelet: formData.get('platelet'),
                equipment: formData.get('equipment'),
                remarks: formData.get('remarks'),
                testedBy: labStaff.name, // Auto-recorded
                date: new Date().toISOString(),
                status: 'Completed'
            };

            const tests = JSON.parse(localStorage.getItem('labTests')) || [];
            tests.push(testData);
            localStorage.setItem('labTests', JSON.stringify(tests));
            
            alert('Hematology test submitted successfully!');
            event.target.reset();
            loadHematologyTests();
            updateDashboard();
        }

        // Submit Chemistry Test
        function submitChemistryTest(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const testData = {
                id: Date.now(),
                section: 'Clinical Chemistry',
                patientId: formData.get('patientId'),
                patientName: formData.get('patientName'),
                testName: formData.get('testName'),
                fbs: formData.get('fbs'),
                cholesterol: formData.get('cholesterol'),
                triglycerides: formData.get('triglycerides'),
                creatinine: formData.get('creatinine'),
                alt: formData.get('alt'),
                ast: formData.get('ast'),
                equipment: formData.get('equipment'),
                remarks: formData.get('remarks'),
                testedBy: labStaff.name, // Auto-recorded
                date: new Date().toISOString(),
                status: 'Completed'
            };

            const tests = JSON.parse(localStorage.getItem('labTests')) || [];
            tests.push(testData);
            localStorage.setItem('labTests', JSON.stringify(tests));
            
            alert('Chemistry test submitted successfully!');
            event.target.reset();
            loadChemistryTests();
            updateDashboard();
        }

        // Submit Microbiology Test
        function submitMicrobiologyTest(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const testData = {
                id: Date.now(),
                section: 'Microbiology',
                patientId: formData.get('patientId'),
                patientName: formData.get('patientName'),
                testName: formData.get('testName'),
                gramStain: formData.get('gramStain'),
                organism: formData.get('organism'),
                colonyCount: formData.get('colonyCount'),
                cultureResult: formData.get('cultureResult'),
                incubation: formData.get('incubation'),
                sensitivity: formData.get('sensitivity'),
                remarks: formData.get('remarks'),
                testedBy: labStaff.name, // Auto-recorded
                date: new Date().toISOString(),
                status: 'Completed'
            };

            const tests = JSON.parse(localStorage.getItem('labTests')) || [];
            tests.push(testData);
            localStorage.setItem('labTests', JSON.stringify(tests));
            
            alert('Microbiology test submitted successfully!');
            event.target.reset();
            loadMicrobiologyTests();
            updateDashboard();
        }

        // Load Hematology Tests
        function loadHematologyTests() {
            const tests = JSON.parse(localStorage.getItem('labTests')) || [];
            const hematologyTests = tests.filter(test => test.section === 'Hematology');
            const tbody = document.getElementById('hematologyTable');
            
            if (hematologyTests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No test results yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = hematologyTests.map(test => `
                <tr>
                    <td>${test.patientId}</td>
                    <td>${test.patientName}</td>
                    <td>${test.testName}</td>
                    <td>
                        ${test.wbc ? `WBC: ${test.wbc}<br>` : ''}
                        ${test.rbc ? `RBC: ${test.rbc}<br>` : ''}
                        ${test.hemoglobin ? `Hgb: ${test.hemoglobin}<br>` : ''}
                        ${test.platelet ? `PLT: ${test.platelet}` : ''}
                    </td>
                    <td>${test.testedBy}</td>
                    <td>${new Date(test.date).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-sm btn-danger" onclick="deleteTest(${test.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Load Chemistry Tests
        function loadChemistryTests() {
            const tests = JSON.parse(localStorage.getItem('labTests')) || [];
            const chemistryTests = tests.filter(test => test.section === 'Clinical Chemistry');
            const tbody = document.getElementById('chemistryTable');
            
            if (chemistryTests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No test results yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = chemistryTests.map(test => `
                <tr>
                    <td>${test.patientId}</td>
                    <td>${test.patientName}</td>
                    <td>${test.testName}</td>
                    <td>
                        ${test.fbs ? `FBS: ${test.fbs}<br>` : ''}
                        ${test.cholesterol ? `Chol: ${test.cholesterol}<br>` : ''}
                        ${test.creatinine ? `Creat: ${test.creatinine}` : ''}
                    </td>
                    <td>${test.testedBy}</td>
                    <td>${new Date(test.date).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-sm btn-danger" onclick="deleteTest(${test.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Load Microbiology Tests
        function loadMicrobiologyTests() {
            const tests = JSON.parse(localStorage.getItem('labTests')) || [];
            const microbiologyTests = tests.filter(test => test.section === 'Microbiology');
            const tbody = document.getElementById('microbiologyTable');
            
            if (microbiologyTests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: hsl(var(--muted-foreground)); padding: 2rem;">No test results yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = microbiologyTests.map(test => `
                <tr>
                    <td>${test.patientId}</td>
                    <td>${test.patientName}</td>
                    <td>${test.testName}</td>
                    <td>${test.organism || 'N/A'}</td>
                    <td>${test.cultureResult || 'N/A'}</td>
                    <td>${test.testedBy}</td>
                    <td>${new Date(test.date).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-sm btn-danger" onclick="deleteTest(${test.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Delete Test
        function deleteTest(testId) {
            if (!confirm('Are you sure you want to delete this test?')) return;
            
            const tests = JSON.parse(localStorage.getItem('labTests')) || [];
            const filteredTests = tests.filter(test => test.id !== testId);
            localStorage.setItem('labTests', JSON.stringify(filteredTests));
            
            // Reload current section
            const activeSection = document.querySelector('.content-section.hidden') ? document.querySelector('.content-section:not(.hidden)').id : 'dashboard';
            if (activeSection === 'hematology') loadHematologyTests();
            else if (activeSection === 'chemistry') loadChemistryTests();
            else if (activeSection === 'microbiology') loadMicrobiologyTests();
            
            updateDashboard();
        }

        // Delete Equipment
        function deleteEquipment(equipmentId) {
            if (!confirm('Are you sure you want to delete this equipment?')) return;
            
            const equipment = JSON.parse(localStorage.getItem('equipment')) || [];
            const filteredEquipment = equipment.filter(item => item.id !== equipmentId);
            localStorage.setItem('equipment', JSON.stringify(filteredEquipment));
            
            loadEquipment();
            updateDashboard();
        }

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.remove('hidden');
            // Use event.currentTarget if the event is passed
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                // Fallback if event is not passed or is undefined (e.g., direct call)
                const activeNavItem = document.querySelector(`.nav-item > div[onclick*="${sectionId}"]`);
                if (activeNavItem) activeNavItem.classList.add('active');
            }
        }

        async function logout() {
            if (!confirm('Are you sure you want to logout?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    window.location.href = data.redirect;
                }
            } catch (err) {
                console.error('Logout error:', err);
                window.location.href = '/IMS';
            }
        }
        // Initialize on page load
        window.onload = function() {
            updateDashboard();
            loadSamples();
            loadEquipment();
            loadInventory();
            populateQCEquipment();
            loadHematologyTests();
            loadChemistryTests();
            loadMicrobiologyTests();
            
            // Set the initial active section
            showSection('dashboard');
        };

    </script>
</body>
</html>
