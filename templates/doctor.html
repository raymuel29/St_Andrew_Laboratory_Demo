<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor/Nurse Module - St. Andrew Hospital</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: hsl(168, 85%, 60%);
            --primary-foreground: hsl(0, 0%, 100%);
            --secondary: hsl(240, 4%, 16%);
            --secondary-foreground: hsl(0, 0%, 100%);
            --accent: hsl(142, 71%, 45%);
            --accent-foreground: hsl(0, 0%, 100%);
            --background: hsl(0, 0%, 7%);
            --foreground: hsl(0, 0%, 98%);
            --card: hsl(240, 4%, 10%);
            --card-foreground: hsl(0, 0%, 98%);
            --border: hsl(240, 4%, 16%);
            --muted: hsl(240, 4%, 16%);
            --muted-foreground: hsl(240, 5%, 65%);
        }
        
        body {
            background-color: var(--background);
            color: var(--foreground);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.2s;
            font-size: 14px;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            font-size: 14px;
        }
        
        .btn-secondary:hover {
            background-color: hsl(240, 4%, 20%);
        }
        
        .btn-success {
            background-color: var(--accent);
            color: var(--accent-foreground);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }
        
        .nav-item {
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--foreground);
        }
        
        .nav-item:hover {
            background-color: var(--secondary);
        }
        
        .nav-item.active {
            background-color: var(--secondary);
            color: var(--primary);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            color: var(--muted-foreground);
            font-size: 14px;
            font-weight: 500;
        }
        
        .table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        
        .table tr:hover {
            background-color: hsl(240, 4%, 12%);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        input, select, textarea {
            background-color: var(--secondary);
            border: 1px solid var(--border);
            color: var(--foreground);
            padding: 10px 14px;
            border-radius: 6px;
            width: 100%;
            font-size: 14px;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px hsla(168, 85%, 60%, 0.1);
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--foreground);
        }

        .hidden {
            display: none !important;
        }

        /* Header styles */
        header {
            border-bottom: 1px solid var(--border);
            background-color: var(--card);
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--accent);
        }

        .header-title h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .header-title p {
            font-size: 14px;
            color: var(--muted-foreground);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-user {
            color: var(--muted-foreground);
        }

        /* Layout */
        .main-layout {
            display: flex;
        }

        aside {
            width: 256px;
            min-height: calc(100vh - 72px);
            border-right: 1px solid var(--border);
            padding: 16px;
            background-color: var(--card);
        }

        main {
            flex: 1;
            padding: 24px;
            min-height: calc(100vh - 72px);
        }

        nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Content sections */
        .content-section {
            width: 100%;
        }

        .page-content {
            width: 100%;
        }

        /* Dashboard styles */
        .dashboard-filters {
            margin-bottom: 24px;
        }

        .dashboard-filters h2 {
            font-size: 24px;
            color: var(--primary);
            margin: 0;
        }

        .dashboard-table-container {
            background-color: var(--card);
            border-radius: 8px;
            padding: 20px;
        }

        .table-container {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .table-container table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-container thead {
            background-color: var(--secondary);
        }

        .table-container th {
            padding: 12px;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 1px solid var(--border);
            color: var(--muted-foreground);
            text-align: left;
        }

        .table-container td {
            padding: 12px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .table-container tbody tr:hover {
            background-color: hsl(240, 4%, 12%);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* Messages Section Styles */
        .flex {
            display: flex;
        }

        .justify-between {
            justify-content: space-between;
        }

        .items-center {
            align-items: center;
        }

        .mb-6 {
            margin-bottom: 24px;
        }

        .grid {
            display: grid;
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .col-span-1 {
            grid-column: span 1;
        }

        .col-span-2 {
            grid-column: span 2;
        }

        .gap-6 {
            gap: 24px;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-1 {
            flex: 1;
        }

        .p-4 {
            padding: 16px;
        }

        .pt-2 {
            padding-top: 8px;
        }

        .border-b {
            border-bottom: 1px solid var(--border);
        }

        .border-t {
            border-top: 1px solid var(--border);
        }

        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }

        .mb-4 {
            margin-bottom: 16px;
        }

        .text-center {
            text-align: center;
        }

        .conversation-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }

        .conversation-item:hover {
            background-color: var(--secondary);
            border-color: var(--border);
        }

        .conversation-item.active {
            background-color: var(--secondary);
            border-color: var(--primary);
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .conversation-name {
            font-weight: 600;
            font-size: 14px;
        }

        .conversation-time {
            font-size: 12px;
            color: var(--muted-foreground);
        }

        .conversation-preview {
            font-size: 13px;
            color: var(--muted-foreground);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .unread-badge {
            background-color: var(--primary);
            color: var(--primary-foreground);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            word-wrap: break-word;
        }

        .message-sent {
            background-color: var(--primary);
            color: var(--primary-foreground);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message-received {
            background-color: var(--secondary);
            color: var(--foreground);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* Page Section Styles */
        .page-section {
            width: 100%;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .page-header h1 {
            font-size: 24px;
            color: var(--foreground);
            font-weight: 600;
        }


        /* Tabs System - WRAPPED VERSION */
        .tabs {
            display: flex;
            flex-wrap: wrap; /* This makes tabs wrap to next line */
            gap: 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 0;
            background-color: var(--card);
        }

        .tab {
            padding: 12px 18px; /* Slightly reduced padding */
            background: none;
            border: none;
            color: var(--muted-foreground);
            cursor: pointer;
            font-size: 13px; /* Slightly smaller font */
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            position: relative;
        }

        .tab:hover {
            color: var(--foreground);
            background-color: hsla(168, 85%, 60%, 0.05);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background-color: hsla(168, 85%, 60%, 0.1);
        }

        /* Tab content stays the same */
        .tab-content {
            display: none;
            padding: 24px;
        }

        .tab-content.active {
            display: block;
        }


        /* Info Box */
        .info-box {
            background-color: hsla(168, 85%, 60%, 0.1);
            border-left: 4px solid var(--primary);
            padding: 12px 16px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box p {
            margin: 0;
            color: var(--foreground);
            font-size: 14px;
        }

        /* Order Type Buttons */
        .order-type-btns {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 16px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        /* Treatment Section */
        .treatment-section {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .treatment-section h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--foreground);
            font-weight: 600;
        }

        .treatment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .treatment-title {
            font-size: 18px;
            color: var(--foreground);
            margin: 0;
            font-weight: 600;
        }

        /* Detail Rows */
        .detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: var(--muted-foreground);
            width: 200px;
            min-width: 200px;
        }

        .detail-value {
            color: var(--foreground);
            flex: 1;
        }

        /* Vital Signs Grid */
        .vital-signs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .vital-item {
            background-color: var(--secondary);
            padding: 16px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .vital-item label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--muted-foreground);
            font-weight: 500;
        }

        .vital-item input {
            width: 100%;
            background-color: var(--card);
        }

        /* Checkbox Group */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 14px;
        }

        /* Required Field Indicator */
        .required::after {
            content: " *";
            color: hsl(0, 72%, 65%);
        }

        /* Bill Items List */
        #billItemsList,
        #treatmentBillItemsList {
            background-color: var(--background);
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
        }

        /* Bill Section Headers */
        .bill-section-header {
            background-color: var(--secondary);
            padding: 12px 16px;
            margin: 24px 0 16px 0;
            border-radius: 6px;
            font-weight: 600;
            font-size: 15px;
            color: var(--foreground);
        }

        .bill-section-header:first-child {
            margin-top: 0;
        }

        /* Bill Item */
        .bill-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px;
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 12px;
            transition: background-color 0.2s;
        }

        .bill-item:hover {
            background-color: hsl(240, 4%, 12%);
        }

        .bill-item-info {
            flex: 1;
        }

        .bill-item-name {
            font-weight: 600;
            color: var(--foreground);
            font-size: 15px;
            margin-bottom: 4px;
        }

        .bill-item-date {
            font-size: 12px;
            color: var(--muted-foreground);
        }

        .bill-item-amount {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            white-space: nowrap;
            margin-left: 16px;
        }

        /* Bill Total */
        .bill-total {
            background: linear-gradient(135deg, var(--card) 0%, hsl(240, 4%, 13%) 100%);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .bill-total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .bill-total-label {
            font-size: 16px;
            color: var(--muted-foreground);
        }

        .bill-total-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        /* Button Variants */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            border: none;
            transition: all 0.2s;
        }

        .btn-warning {
            background-color: hsl(35, 91%, 56%);
            color: hsl(0, 0%, 100%);
        }

        .btn-warning:hover {
            background-color: hsl(35, 91%, 48%);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .vital-signs-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                gap: 0;
            }

            .tab {
                padding: 12px 16px;
                font-size: 13px;
            }

            .treatment-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }


        /* Utilities */
        .w-5 { width: 20px; }
        .h-5 { height: 20px; }
        .w-6 { width: 24px; }
        .h-6 { height: 24px; }
        .w-10 { width: 40px; }
        .h-10 { height: 40px; }
        .w-16 { width: 64px; }
        .h-16 { height: 64px; }

        .ml-auto {
            margin-left: auto;
        }

        .badge-danger {
            background-color: hsl(0, 72%, 51%, 0.2);
            color: hsl(0, 72%, 65%);
        }

        .rounded-full {
            border-radius: 9999px;
        }

        .font-semibold {
            font-weight: 600;
        }

        .text-sm {
            font-size: 14px;
        }

        .gap-2 {
            gap: 8px;
        }

        .gap-3 {
            gap: 12px;
        }

        .items-center {
            align-items: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: var(--card);
            border-radius: 8px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted-foreground);
        }

        .space-y-4 > * + * {
            margin-top: 16px;
        }

        

    </style>
</head>
<body>
    
    <header>
        <div class="header-container">
            <div class="header-left">
                <div class="header-icon">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                </div>
                <div class="header-title">
                    <h1>Doctor/Nurse System</h1>
                    <p>St. Andrew Hospital</p>
                </div>
            </div>
            <div class="header-right">
                <span class="header-user">Staff: <span id="currentUserName">Loading...</span></span>
                <button class="btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-layout">
        <!-- Sidebar with main navigation -->
        <aside>
            <nav>
                <div class="nav-item active" onclick="showSection('my-schedule')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>My Schedule</span>
                </div>
                <div class="nav-item" onclick="showSection('appointments')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span>Appointments</span>
                </div>
                <div class="nav-item" onclick="showSection('outpatients')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <span>Out Patient</span>
                </div>
                <div class="nav-item" onclick="showSection('patients', event)">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span>In Patient</span>
                </div>
                <div class="nav-item" onclick="showSection('messages')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    <span>Messages</span>
                    <span class="badge badge-danger ml-auto" id="unreadCount">3</span>
                </div>
            </nav>
        </aside>
        

        <!-- Main Content -->
        <main>
            
            <!-- My Schedule Page-->
            <section id="my-schedule" class="content-section">
                <!-- Today & Upcoming Schedule -->
                <div class="dashboard-filters">
                    <h2>My Schedule - Today & Upcoming</h2>
                </div>

                <div class="dashboard-table-container">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Date & Time</th>
                                    <th>Service Type</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleAppointmentsTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #888; padding: 40px;">
                                        No upcoming appointments
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Past Appointments Section -->
                <div class="dashboard-filters" style="margin-top: 40px;">
                    <h2>Past Appointments</h2>
                </div>

                <div class="dashboard-table-container">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Date & Time</th>
                                    <th>Service Type</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="pastAppointmentsTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #888; padding: 40px;">
                                        No past appointments
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
                
                
            <!-- APPOINTMENTS -->
            <section id="appointments" class="content-section hidden">
                <!-- Page Header matching Visit Dashboard style -->
                <div class="dashboard-filters">
                    <h2>My Appointments</h2>
                </div>

                <!-- Table Container matching Visit Dashboard style -->
                <div class="dashboard-table-container">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Date & Time</th>
                                    <th>Service Type</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="pendingAppointmentsTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #888; padding: 40px;">
                                        No pending appointments
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            

            <!-- Out Patient Page -->
            <section id="outpatients" class="content-section hidden">
                <div class="dashboard-filters">
                    <h2>Out Patient List</h2>
                </div>                    
                <div class="dashboard-table-container">
                    <h3 style="margin-bottom: 20px;">Out Patients - Today's Visits</h3>
                    <div class="table-container">
                        <table id="outpatientsTable">
                            <thead>
                                <tr>
                                    <th>Patient Name</th>
                                    <th>Visit Date</th>
                                    <th>Visit Type</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="outpatientsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #888; padding: 40px;">
                                        Loading out patients...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

                
            <!-- In Patient Page -->
            <section id="patients" class="content-section hidden">
                <div class="dashboard-filters">
                    <h2>In Patient List</h2>
                </div>                    
                <div class="dashboard-table-container">
                    <h3 style="margin-bottom: 20px;">Admitted Patients</h3>
                    <div class="table-container">
                        <table id="patientsTable">
                            <thead>
                                <tr>
                                    <th>Patient Name</th>
                                    <th>Admission Date</th>
                                    <th>Room</th>
                                    <th>Days Admitted</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="patientsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #888; padding: 40px;">
                                        Loading admitted patients...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

                
            <!-- Messages Section -->
            <section id="messages" class="content-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">Messages</h2>
                    <button class="btn-primary" onclick="openCompose()">+ New Message</button>
                </div>

                <div class="grid grid-cols-3 gap-6" style="height: calc(100vh - 200px);">
                    <!-- Conversation List -->
                    <div class="card col-span-1 flex flex-col" style="height: 100%;">
                        <div class="p-4 border-b" style="border-color: var(--border);">
                            <div class="search-box">
                                <svg class="search-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                                <input type="text" placeholder="Search conversations..." >
                            </div>
                            <div id="conversationList" class="flex-1 pt-2" style="overflow-y: auto;">
                                <!--message list appear here-->
                            </div>
                        </div>
                    </div>

                    <!-- Chat Window -->
                    <div class="card col-span-2" style="height: 100%; display: flex; flex-direction: column;">
                        <!-- Chat Header -->
                        <div id="chatHeader" class="p-4 border-b" style="border-color: var(--border); display: none;">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color: var(--primary);">
                                    <span id="chatContactInitial" class="font-semibold"></span>
                                </div>
                                <div class="flex-1">
                                    <div id="chatContactName" class="font-semibold"></div>
                                    <div id="chatContactRole" class="text-sm" style="color: var(--muted-foreground);"></div>
                                </div>
                                <button class="btn-secondary text-sm" onclick="closeConversation()">Close</button>
                            </div>
                        </div>

                        <!-- Messages Container -->
                        <div id="messagesContainer" class="p-4" style="flex: 1; overflow-y: auto; background-color: var(--background); display: none;"></div>

                        <!-- Empty State -->
                        <div id="noConversationText" style="flex: 1; display: flex; align-items: center; justify-content: center; color: var(--muted-foreground);">
                            <div class="text-center">
                                <svg class="w-16 h-16 mx-auto mb-4" style="color: var(--muted-foreground);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                <p>Select a conversation to start messaging</p>
                            </div>
                        </div>

                        <!-- Message Input -->
                        <div id="messageInputContainer" class="p-4 border-t" style="border-color: var(--border); display: none;">
                            <div class="flex gap-2">
                                <input type="text" id="messageInput" placeholder="Type a message..." class="flex-1" onkeypress="handleMessageKeyPress(event)">
                                <button class="btn-primary" onclick="sendChatMessage()">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compose Modal -->
                <div class="modal" id="composeModal">
                    <div class="modal-content p-6">
                        <h3 class="text-lg font-semibold mb-4">New Message</h3>
                        <div class="space-y-4">
                            <div>
                                <label>To</label>
                                <select id="composeTo">
                                    <option value="">Select recipient</option>
                                    <option value="Dr. Sarah Johnson">Dr. Sarah Johnson</option>
                                    <option value="Dr. Michael Chen">Dr. Michael Chen</option>
                                    <option value="Billing Department">Billing Department</option>
                                    <option value="Pharmacy">Pharmacy</option>
                                    <option value="Laboratory">Laboratory</option>
                                    <option value="Nursing Station">Nursing Station</option>
                                </select>
                            </div>
                            <div>
                                <label>Subject</label>
                                <input type="text" id="composeSubject" placeholder="Message subject">
                            </div>
                            <div>
                                <label>Message</label>
                                <textarea id="composeBody" rows="5" placeholder="Type your message here..."></textarea>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn-primary flex-1" onclick="sendNewMessage()">Send</button>
                                <button class="btn-secondary flex-1" onclick="closeCompose()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Patient Orders SECTION -->
            <section id="patientOrdersPage" class="content-section hidden">
                <div class="page-section">
                    <div class="page-header">
                        <h1 id="ordersPageTitle">Patient Orders</h1>
                        <button class="btn btn-secondary" onclick="showSection('patients')">‚Üê Back to List</button>
                    </div>
    
                    <div class="card">
                        <div class="tabs">
                            <button class="tab active" onclick="switchOrdersTab('addOrders')">Add Orders</button>
                            <button class="tab" onclick="switchOrdersTab('runningBill')">Running Bill</button>
                        </div>
    
                        <!-- Add Orders Tab -->
                        <div id="addOrders" class="tab-content active">
                            <div class="info-box">
                                <p>Orders will automatically be added to the patient's running bill</p>
                            </div>
    
                            <div class="form-group">
                                <label>Order Type</label>
                                <div class="order-type-btns">
                                    <button class="btn btn-primary" onclick="selectOrderType('laboratory')">Laboratory</button>
                                    <button class="btn btn-primary" onclick="selectOrderType('pharmacy')">Pharmacy</button>
                                    <button class="btn btn-primary" onclick="selectOrderType('procedures')">Procedures</button>
                                </div>
                            </div>
    
                            <div class="form-group">
                                <label>Select Service</label>
                                <select id="serviceSelect">
                                    <option value="">-- Select Order Type First --</option>
                                </select>
                            </div>
    
                            <button class="btn btn-primary" onclick="addOrderToBill()">Add Order to Bill</button>
    
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                                <button class="btn btn-warning" onclick="addHospitalDay()">Add Hospital Day</button>
                                <p style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">Adds room charge for the next day</p>
                            </div>
                        </div>
    
                        <!-- Running Bill Tab -->
                        <div id="runningBill" class="tab-content">
                            <div class="info-box">
                                <p>This bill updates automatically as new orders are added</p>
                            </div>
                            <div id="billItemsList"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Medical Records SECTION -->
            <section id="medicalRecordsPage" class="content-section hidden">
                <div class="page-section">
                    <div class="page-header">
                        <h1 id="medicalRecordsTitle">Patient Medical Records</h1>
                        <button class="btn btn-secondary" onclick="showSection('patients')">‚Üê Back to List</button>
                    </div>
    
                    <div class="card">
                        <div class="tabs">
                            <button class="tab active" onclick="switchMainTab('patientInfo')">Patient Info</button>
                            <button class="tab" onclick="switchMainTab('vitals')">Vital Signs</button>
                            <button class="tab" onclick="switchMainTab('allergies')">Allergies</button>
                            <button class="tab" onclick="switchMainTab('currentMedication')">Current Medication</button>
                            <button class="tab" onclick="switchMainTab('complaint')">Presenting Complaint</button>
                            <button class="tab" onclick="switchMainTab('history')">History & Examination</button>
                            <button class="tab" onclick="switchMainTab('diagnosis')">Diagnosis</button>
                            <button class="tab" onclick="switchMainTab('investigation')">Investigation</button>
                            <button class="tab" onclick="switchMainTab('prescription')">Prescription</button>
                            <button class="tab" onclick="switchMainTab('advice')">Advice</button>
                            <button class="tab" onclick="switchMainTab('certificate')">Medical Certificate</button>
                            <button class="tab" onclick="switchMainTab('referral')">Refer to Doctor</button>
                            <button class="tab" onclick="switchMainTab('billingTab')">Billing</button>
                        </div>
    
                        <!-- Patient Info Tab -->
                        <div id="patientInfo" class="tab-content active">
                            <div class="treatment-section">
                                <h3>üìã Patient Information</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Name:</span>
                                    <span class="detail-value" id="mr-name">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Admission Date:</span>
                                    <span class="detail-value" id="mr-admission">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Days Admitted:</span>
                                    <span class="detail-value" id="mr-days">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Room Type:</span>
                                    <span class="detail-value" id="mr-room">-</span>
                                </div>
                            </div>
    
                            <div class="treatment-section">
                                <h3>üë®‚Äç‚öïÔ∏è Attending Physician</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Doctor:</span>
                                    <span class="detail-value" id="mr-doctor">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Specialty:</span>
                                    <span class="detail-value" id="mr-specialty">-</span>
                                </div>
                            </div>
                        </div>
    
                        <!-- Vital Signs Tab -->
                        <div id="vitals" class="tab-content">
                            <div class="treatment-section">
                                <div class="treatment-header">
                                    <h3 class="treatment-title">üíì Vital Signs</h3>
                                    <button class="btn btn-success" onclick="saveVitalSigns()">
                                        <span>üíæ</span> Save Vital Signs
                                    </button>
                                </div>
                                <div class="vital-signs-grid">
                                    <div class="vital-item">
                                        <label>Temperature</label>
                                        <input type="text" id="mr-temp" placeholder="36.5¬∞C">
                                    </div>
                                    <div class="vital-item">
                                        <label>Blood Pressure</label>
                                        <input type="text" id="mr-bp" placeholder="120/80">
                                    </div>
                                    <div class="vital-item">
                                        <label>Heart Rate</label>
                                        <input type="text" id="mr-hr" placeholder="72 bpm">
                                    </div>
                                    <div class="vital-item">
                                        <label>Respiratory Rate</label>
                                        <input type="text" id="mr-rr" placeholder="16/min">
                                    </div>
                                    <div class="vital-item">
                                        <label>Oxygen Saturation</label>
                                        <input type="text" id="mr-o2" placeholder="98%">
                                    </div>
                                    <div class="vital-item">
                                        <label>Weight</label>
                                        <input type="text" id="mr-weight" placeholder="70 kg">
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Allergies Tab -->
                        <div id="allergies" class="tab-content">
                            <div class="treatment-section">
                                <div class="treatment-header">
                                    <h3 class="treatment-title">üö® Allergies</h3>
                                    <button class="btn btn-primary" onclick="addAllergy()">
                                        <span>+</span> Add Allergy
                                    </button>
                                </div>
    
                                <div class="form-row-3">
                                    <div class="form-group">
                                        <label class="required">Allergy Type</label>
                                        <select id="allergyType">
                                            <option>Select</option>
                                            <option>Drug Allergy</option>
                                            <option>Food Allergy</option>
                                            <option>Environmental</option>
                                            <option>Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Allergen</label>
                                        <input type="text" id="allergen" placeholder="Enter allergen">
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Reaction</label>
                                        <input type="text" id="allergyReaction" placeholder="Describe reaction">
                                    </div>
                                </div>
    
                                <div class="table-container">
                                    <table id="allergiesTable">
                                        <thead>
                                            <tr>
                                                <th>SN</th>
                                                <th>Allergy Type</th>
                                                <th>Allergen</th>
                                                <th>Reaction</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="allergiesTableBody">
                                            <tr>
                                                <td colspan="5" style="text-align: center; color: #7f8c8d;">No allergies recorded</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
    
                        <!-- Current Medication Tab -->
                        <div id="currentMedication" class="tab-content">
                            <div class="treatment-section">
                                <h3>üíä Current Medication</h3>
                                <div class="info-box">
                                    <p><strong>Note:</strong> List all medications the patient is currently taking from outside, including dosage and frequency.</p>
                                </div>
    
                                <div class="form-row-3">
                                    <div class="form-group">
                                        <label class="required">Medicine Name</label>
                                        <input type="text" id="currentMedName" placeholder="Enter medicine name">
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Dosage</label>
                                        <input type="text" id="currentMedDosage" placeholder="e.g., 500mg">
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Frequency</label>
                                        <input type="text" id="currentMedFrequency" placeholder="e.g., Twice daily">
                                    </div>
                                </div>
    
                                <button class="btn btn-primary" onclick="addCurrentMedication()">
                                    <span>+</span> Add Medication
                                </button>
    
                                <div class="table-container">
                                    <table id="currentMedicationTable">
                                        <thead>
                                            <tr>
                                                <th>Medicine Name</th>
                                                <th>Dosage</th>
                                                <th>Frequency</th>
                                                <th>Prescribed By</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="currentMedicationTableBody">
                                            <tr>
                                                <td colspan="5" style="text-align: center; color: #7f8c8d;">No current medications recorded</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
    
                        <!-- Presenting Complaint Tab -->
                        <div id="complaint" class="tab-content">
                            <div class="treatment-section">
                                <div class="treatment-header">
                                    <h3 class="treatment-title">üìù Presenting Complaint</h3>
                                    <button class="btn btn-success" onclick="saveComplaint()">
                                        <span>üíæ</span> Save
                                    </button>
                                </div>
    
                                <div class="form-group">
                                    <label class="required">Chief Complaint</label>
                                    <textarea id="chiefComplaint" placeholder="What brought the patient to the hospital? Describe the main symptoms..."></textarea>
                                </div>
    
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Duration</label>
                                        <input type="text" id="complaintDuration" placeholder="e.g., 3 days, 2 weeks">
                                    </div>
                                    <div class="form-group">
                                        <label>Severity</label>
                                        <select id="complaintSeverity">
                                            <option>Select severity</option>
                                            <option>Mild</option>
                                            <option>Moderate</option>
                                            <option>Severe</option>
                                        </select>
                                    </div>
                                </div>
    
                                <div class="form-group">
                                    <label>Associated Symptoms</label>
                                    <textarea id="associatedSymptoms" placeholder="Any other symptoms related to the chief complaint..."></textarea>
                                </div>
                            </div>
                        </div>
    
                        <!-- History & Examination Tab -->
                        <div id="history" class="tab-content">
                            <div class="treatment-section">
                                <div class="treatment-header">
                                    <h3 class="treatment-title">üìö History and Examination</h3>
                                    <button class="btn btn-success" onclick="saveHistory()">
                                        <span>üíæ</span> Save
                                    </button>
                                </div>
    
                                <div class="form-group">
                                    <label>History of Present Illness (HPI)</label>
                                    <textarea id="hpi" placeholder="Detailed description of the current illness..."></textarea>
                                </div>
    
                                <div class="form-group">
                                    <label>Past Medical History</label>
                                    <textarea id="pastHistory" placeholder="Previous illnesses, surgeries, hospitalizations..."></textarea>
                                </div>
    
                                <div class="form-group">
                                    <label>Family History</label>
                                    <textarea id="familyHistory" placeholder="Relevant family medical history..."></textarea>
                                </div>
    
                                <div class="form-group">
                                    <label>Social History</label>
                                    <textarea id="socialHistory" placeholder="Smoking, alcohol, occupation, living situation..."></textarea>
                                </div>
    
                                <div class="form-group">
                                    <label>Physical Examination</label>
                                    <textarea id="physicalExam" placeholder="General appearance, system examination findings..."></textarea>
                                </div>
    
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Cardiovascular System</label>
                                        <textarea id="cardiovascular" placeholder="Heart sounds, murmurs, etc..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Respiratory System</label>
                                        <textarea id="respiratory" placeholder="Breath sounds, respiratory pattern..."></textarea>
                                    </div>
                                </div>
    
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Abdomen</label>
                                        <textarea id="abdomen" placeholder="Inspection, palpation, bowel sounds..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Neurological</label>
                                        <textarea id="neurological" placeholder="Mental status, reflexes, motor/sensory..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Diagnosis Tab -->
                        <div id="diagnosis" class="tab-content">
                            <div class="treatment-section">
                                <div class="treatment-header">
                                    <h3 class="treatment-title">ü©∫ Diagnosis</h3>
                                    <button class="btn btn-primary" onclick="addDiagnosis()">
                                        <span>+</span> Add Diagnosis
                                    </button>
                                </div>
    
                                <div class="form-row-3">
                                    <div class="form-group">
                                        <label>Attendance</label>
                                        <select id="diagAttendance">
                                            <option>Emergency/Acute</option>
                                            <option>Routine/Scheduled</option>
                                            <option>Follow-up</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Type</label>
                                        <select id="diagType">
                                            <option>Provisional</option>
                                            <option>Confirmed</option>
                                            <option>Differential</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Category</label>
                                        <select id="diagCategory">
                                            <option>Primary</option>
                                            <option>Secondary</option>
                                            <option>Tertiary</option>
                                        </select>
                                    </div>
                                </div>
    
                                <div class="form-row-3">
                                    <div class="form-group">
                                        <label class="required">Diagnosis</label>
                                        <input type="text" id="diagnosisName" placeholder="Search diagnosis name">
                                    </div>
                                    <div class="form-group">
                                        <label>ICD-10 Code</label>
                                        <input type="text" id="icd10Code" placeholder="ICD-10 code">
                                    </div>
                                    <div class="form-group">
                                        <label>Country Code</label>
                                        <input type="text" id="countryCode" placeholder="Country code">
                                    </div>
                                </div>
    
                                <div class="form-group">
                                    <label>Remarks</label>
                                    <textarea id="diagRemarks" placeholder="Additional notes about the diagnosis..."></textarea>
                                </div>
    
                                <div class="table-container">
                                    <table id="diagnosisTable">
                                        <thead>
                                            <tr>
                                                <th>SN</th>
                                                <th>Attendance</th>
                                                <th>Type</th>
                                                <th>Category</th>
                                                <th>Diagnosis</th>
                                                <th>ICD-10</th>
                                                <th>Remarks</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="diagnosisTableBody">
                                            <tr>
                                                <td colspan="8" style="text-align: center; color: #7f8c8d;">No diagnosis recorded</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
    
                        <!-- Investigation Tab -->
                        <div id="investigation" class="tab-content">
                            <div class="treatment-section">
                                <div class="treatment-header">
                                    <h3 class="treatment-title">üî¨ Investigation/Procedure</h3>
                                    <button class="btn btn-primary" onclick="addInvestigation()">
                                        <span>+</span> Order Investigation
                                    </button>
                                </div>
    
                                <div class="form-group">
                                    <label class="required">Investigation/Procedure</label>
                                    <select id="investigationSelect">
                                        <option value="">-- Select Service --</option>
                                    </select>
                                </div>
    
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Units</label>
                                        <input type="number" id="investigationUnits" value="1" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label>STAT (Urgent)</label>
                                        <select id="investigationStat">
                                            <option>No</option>
                                            <option>Yes</option>
                                        </select>
                                    </div>
                                </div>
    
                                <div class="form-group">
                                    <label>Remarks</label>
                                    <textarea id="investigationRemarks" placeholder="Special instructions..."></textarea>
                                </div>
    
                                <div class="table-container">
                                    <table id="investigationTable">
                                        <thead>
                                            <tr>
                                                <th>SN</th>
                                                <th>Order Date</th>
                                                <th>Investigation</th>
                                                <th>Units</th>
                                                <th>Amount</th>
                                                <th>Status</th>
                                                <th>STAT</th>
                                                <th>Remarks</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="investigationTableBody">
                                            <tr>
                                                <td colspan="9" style="text-align: center; color: #7f8c8d;">No investigations ordered</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
    
                        <!-- Prescription Tab -->
                        <div id="prescription" class="tab-content">
                            <div class="treatment-section">
                                <div class="treatment-header">
                                    <h3 class="treatment-title">üíä Prescription Medicine</h3>
                                    <button class="btn btn-primary" onclick="addPrescription()">
                                        <span>+</span> Add Prescription
                                    </button>
                                </div>
    
                                <div class="form-row-3">
                                    <div class="form-group">
                                        <label class="required">Medicine</label>
                                        <select id="medicineSelect">
                                            <option value="">-- Select Medicine --</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Dosage</label>
                                        <input type="text" id="medicineDosage" placeholder="e.g., 500mg">
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Frequency</label>
                                        <select id="medicineFrequency">
                                            <option>Once daily</option>
                                            <option>Twice daily</option>
                                            <option>Three times daily</option>
                                            <option>Four times daily</option>
                                            <option>Every 4 hours</option>
                                            <option>Every 6 hours</option>
                                            <option>As needed</option>
                                        </select>
                                    </div>
                                </div>
    
                                <div class="form-row-3">
                                    <div class="form-group">
                                        <label class="required">No. of Days</label>
                                        <input type="number" id="medicineDays" value="7" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label>Food Relation</label>
                                        <select id="medicineFoodRelation">
                                            <option>Not specified</option>
                                            <option>Before meals</option>
                                            <option>After meals</option>
                                            <option>With food</option>
                                            <option>On empty stomach</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Route</label>
                                        <select id="medicineRoute">
                                            <option>Oral</option>
                                            <option>Intravenous (IV)</option>
                                            <option>Intramuscular (IM)</option>
                                            <option>Subcutaneous (SC)</option>
                                            <option>Topical</option>
                                            <option>Inhalation</option>
                                        </select>
                                    </div>
                                </div>
    
                                <div class="form-group">
                                    <label>Special Instructions</label>
                                    <textarea id="medicineInstructions" placeholder="Special instructions for the patient..."></textarea>
                                </div>
    
                                <div class="table-container">
                                    <table id="prescriptionTable">
                                        <thead>
                                            <tr>
                                                <th>SN</th>
                                                <th>Order Date</th>
                                                <th>Medicine</th>
                                                <th>Dosage</th>
                                                <th>Frequency</th>
                                                <th>Duration</th>
                                                <th>Route</th>
                                                <th>Instructions</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="prescriptionTableBody">
                                            <tr>
                                                <td colspan="9" style="text-align: center; color: #7f8c8d;">No prescriptions ordered</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
    
                        <!-- Advice Tab -->
                        <div id="advice" class="tab-content">
                            <div class="treatment-section">
                                <div class="treatment-header">
                                    <h3 class="treatment-title">üìã Advice</h3>
                                    <button class="btn btn-success" onclick="saveAdvice()">
                                        <span>üíæ</span> Save
                                    </button>
                                </div>
    
                                <div class="form-group">
                                    <label>Advice</label>
                                    <textarea id="patientAdvice" placeholder="Enter advice for the patient..."></textarea>
                                </div>
    
                                <div class="form-group">
                                    <label>Follow-up Date</label>
                                    <input type="date" id="followUpDate">
                                </div>
    
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="referEmergency">
                                        <label for="referEmergency">Refer to Emergency</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="referAdmission">
                                        <label for="referAdmission">Refer to Admission</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="surgeryRequest">
                                        <label for="surgeryRequest">Surgery Request</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="referOutside">
                                        <label for="referOutside">Refer to Outside Hospital</label>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Medical Certificate Tab -->
                        <div id="certificate" class="tab-content">
                            <div class="treatment-section">
                                <div class="treatment-header">
                                    <h3 class="treatment-title">üìÑ Medical Certificate</h3>
                                    <button class="btn btn-success" onclick="generateCertificate()">
                                        <span>üì•</span> Generate Certificate
                                    </button>
                                </div>
    
                                <div class="form-row-3">
                                    <div class="form-group">
                                        <label class="required">Certificate Type</label>
                                        <select id="certificateType">
                                            <option>Medical Leave Certificate</option>
                                            <option>Fitness Certificate</option>
                                            <option>General Medical Certificate</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="required">From Date</label>
                                        <input type="date" id="certificateFromDate">
                                    </div>
                                    <div class="form-group">
                                        <label class="required">To Date</label>
                                        <input type="date" id="certificateToDate">
                                    </div>
                                </div>
    
                                <div class="form-group">
                                    <label class="required">Reason</label>
                                    <textarea id="certificateReason" placeholder="Reason for medical certificate..."></textarea>
                                </div>
    
                                <div class="form-group">
                                    <label>Additional Notes</label>
                                    <textarea id="certificateNotes" placeholder="Any additional information..."></textarea>
                                </div>
    
                                <div class="table-container">
                                    <table id="certificateTable">
                                        <thead>
                                            <tr>
                                                <th>Date Issued</th>
                                                <th>Certificate Type</th>
                                                <th>From Date</th>
                                                <th>To Date</th>
                                                <th>Issued By</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="certificateTableBody">
                                            <tr>
                                                <td colspan="6" style="text-align: center; color: #7f8c8d;">No certificates issued</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
    
                        <!-- Referral Tab -->
                        <div id="referral" class="tab-content">
                            <div class="treatment-section">
                                <div class="treatment-header">
                                    <h3 class="treatment-title">üë®‚Äç‚öïÔ∏è Refer to Doctor</h3>
                                    <button class="btn btn-success" onclick="saveReferral()">
                                        <span>üíæ</span> Save Referral
                                    </button>
                                </div>
    
                                <div class="form-row-3">
                                    <div class="form-group">
                                        <label class="required">Refer To</label>
                                        <select id="referToDoctor">
                                            <option>Select Doctor/Specialist</option>
                                            <option>Dr. John Smith - Cardiology</option>
                                            <option>Dr. Sarah Johnson - Neurology</option>
                                            <option>Dr. Michael Brown - Orthopedics</option>
                                            <option>External Specialist</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Specialty</label>
                                        <select id="referSpecialty">
                                            <option>Select Specialty</option>
                                            <option>Cardiology</option>
                                            <option>Neurology</option>
                                            <option>Orthopedics</option>
                                            <option>Gastroenterology</option>
                                            <option>Endocrinology</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Urgency</label>
                                        <select id="referUrgency">
                                            <option>Routine</option>
                                            <option>Urgent</option>
                                            <option>Emergency</option>
                                        </select>
                                    </div>
                                </div>
    
                                <div class="form-group">
                                    <label class="required">Reason for Referral</label>
                                    <textarea id="referReason" placeholder="Explain why the patient needs to see a specialist..."></textarea>
                                </div>
    
                                <div class="form-group">
                                    <label>Clinical Summary</label>
                                    <textarea id="referSummary" placeholder="Brief summary of patient's condition, relevant findings, and current treatment..."></textarea>
                                </div>
    
                                <div class="table-container">
                                    <table id="referralTable">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Referred To</th>
                                                <th>Specialty</th>
                                                <th>Urgency</th>
                                                <th>Reason</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="referralTableBody">
                                            <tr>
                                                <td colspan="7" style="text-align: center; color: #7f8c8d;">No referrals made</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
    
                        <!-- Billing Tab in Medical Records -->
                        <div id="billingTab" class="tab-content">
                            <div class="treatment-section">
                                <div class="treatment-header">
                                    <h3 class="treatment-title">üíµ Running Bill</h3>
                                    <button class="btn btn-warning" onclick="addHospitalDayFromTreatment()">
                                        <span>+</span> Add Hospital Day
                                    </button>
                                </div>
    
                                <div class="info-box">
                                    <p>This bill updates automatically as new orders are added</p>
                                </div>
                                <div id="treatmentBillItemsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Bill Records SECTION -->
            <section id="billRecordsPage" class="content-section hidden">
                <div id="dischargePage" class="page-section">
                    <div class="page-header">
                        <h1 id="dischargePageTitle">Patient Discharge</h1>
                        <button class="btn btn-secondary" onclick="showPage('billing')">‚Üê Back to List</button>
                    </div>
    
                    <div class="card">
                        <div id="dischargeSummary"></div>
    
                        <div class="form-row">
                            <div class="form-group">
                                <label>Insurance Coverage</label>
                                <input type="number" id="insuranceAmount" value="0" oninput="updateFinalBalance()">
                            </div>
    
                            <div class="form-group">
                                <label>Additional Payment</label>
                                <input type="number" id="additionalPayment" value="0" oninput="updateFinalBalance()">
                            </div>
                        </div>
    
                        <div id="finalBalance" class="bill-total"></div>
    
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="processDischarge()">Process Discharge</button>
                            <button class="btn btn-secondary" onclick="showPage('billing')">Cancel</button>
                        </div>
                    </div>
                </div>
            </section>
            

        </main>
    </div>

    <script>
        // Page navigation
        function showSection(sectionId, event = null) {
            console.log('Showing section:', sectionId);

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.add('hidden');
            });

            // Remove active state from sidebar items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show target section
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.remove('hidden');
            } else {
                console.error('Section not found:', sectionId);
            }

            // ONLY apply active nav highlight if event exists
            if (event) {
                const navItem = event.target.closest('.nav-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
            }
        }

        // DOCTOR APPOINTMENTS MANAGEMENT
        let allDoctorAppointments = [];
        let allOutPatients = [];
        let allAdmittedPatients = [];
        let currentPatientData = null;



        // Load current user information on page load
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/current-user');
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('currentUserName').textContent = data.full_name;
                } else {
                    document.getElementById('currentUserName').textContent = 'Unknown User';
                }
            } catch (error) {
                console.error('Error loading current user:', error);
                document.getElementById('currentUserName').textContent = 'Error';
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            // Load current user first
            loadCurrentUser();
            
            // Load appointments
            loadDoctorAppointments();

            // Add to DOMContentLoaded
            loadOutPatients();

            loadAdmittedPatients();
            
            // Initialize BOTH billing containers with complete billing data including totals
            const billItemsHTML = `
                // ... rest of your existing initialization code ...
            `;
            
            // ... rest of your code ...
        });
                

        async function loadDoctorAppointments() {
            console.log('[DEBUG] Loading doctor appointments...');
            try {
                const response = await fetch('/api/doctor/appointments');
                console.log('[DEBUG] Response status:', response.status);
                
                const data = await response.json();
                console.log('[DEBUG] Response data:', data);
                
                if (data.status === 'success') {
                    allDoctorAppointments = data.data || [];
                    console.log('[DEBUG] Loaded appointments:', allDoctorAppointments.length);
                    renderDoctorAppointments();
                } else {
                    console.error('[DEBUG] Failed to load appointments:', data.message);
                    showError('pendingAppointmentsTableBody', data.message);
                    showError('scheduleAppointmentsTableBody', data.message);
                    showError('pastAppointmentsTableBody', data.message);
                }
            } catch (error) {
                console.error('[DEBUG] Error loading appointments:', error);
                const errorMsg = 'Failed to load appointments. Please refresh the page.';
                showError('pendingAppointmentsTableBody', errorMsg);
                showError('scheduleAppointmentsTableBody', errorMsg);
                showError('pastAppointmentsTableBody', errorMsg);
            }
        }

        function showError(tableBodyId, message) {
            const tbody = document.getElementById(tableBodyId);
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #ef4444; padding: 40px;">${message}</td></tr>`;
            }
        }

        function renderDoctorAppointments() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            console.log('[DEBUG] Total appointments:', allDoctorAppointments.length);
            
            // APPOINTMENTS PAGE: Only "Waiting to Approved" status
            const pending = allDoctorAppointments.filter(a => {
                return a.status === 'Waiting to Approved';
            });
            
            // MY SCHEDULE PAGE: Only "Approved" status with future/today dates
            const schedule = allDoctorAppointments.filter(a => {
                const aptDate = new Date(a.appointment_date);
                aptDate.setHours(0, 0, 0, 0);
                return a.status === 'Approved' && aptDate >= today;
            });
            
            // PAST APPOINTMENTS: Completed, Rejected, or Approved with past dates
            const past = allDoctorAppointments.filter(a => {
                const aptDate = new Date(a.appointment_date);
                aptDate.setHours(0, 0, 0, 0);
                
                if (a.status === 'Completed' || a.status === 'Rejected') {
                    return true;
                }
                
                if (a.status === 'Approved' && aptDate < today) {
                    return true;
                }
                
                return false;
            });
            
            console.log('[DEBUG] Pending (Waiting to Approved):', pending.length);
            console.log('[DEBUG] Schedule (Approved & Future):', schedule.length);
            console.log('[DEBUG] Past:', past.length);
            
            renderPendingAppointments(pending);
            renderScheduleAppointments(schedule);
            renderPastAppointments(past);
        }

        function renderPendingAppointments(appointments) {
            const tbody = document.getElementById('pendingAppointmentsTableBody');
            if (!tbody) {
                console.error('[DEBUG] pendingAppointmentsTableBody not found!');
                return;
            }
            
            if (appointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888; padding: 40px;">No appointments waiting for approval</td></tr>';
                return;
            }
            
            tbody.innerHTML = appointments.map((apt) => `
                <tr>
                    <td>
                        <div style="display: flex; flex-direction: column;">
                            <strong>${escapeHtml(apt.patient_name)}</strong>
                        </div>
                    </td>
                    <td>${formatDate(apt.appointment_date)} ${apt.appointment_time}</td>
                    <td>${escapeHtml(apt.service_type)}</td>
                    <td><span class="status-badge" style="background-color: #fef3c7; color: #92400e;">Pending</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-success btn-small" onclick="approveAppointment(${apt.id})">Approve</button>
                            <button class="btn-secondary btn-small" onclick="viewAppointmentDetails(${apt.id})">View</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderScheduleAppointments(appointments) {
            const tbody = document.getElementById('scheduleAppointmentsTableBody');
            if (!tbody) return;
            
            if (appointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888; padding: 40px;">No approved appointments scheduled</td></tr>';
                return;
            }
            
            tbody.innerHTML = appointments.map((apt) => {
                const aptDate = new Date(apt.appointment_date);
                const today = new Date();
                aptDate.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);
                
                const canComplete = aptDate <= today;
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <strong>${escapeHtml(apt.patient_name)}</strong>
                            </div>
                        </td>
                        <td>${formatDate(apt.appointment_date)} ${apt.appointment_time}</td>
                        <td>${escapeHtml(apt.service_type)}</td>
                        <td><span class="status-badge" style="background-color: #d1fae5; color: #065f46;">Approved</span></td>
                        <td>
                            <div class="action-buttons">
                                ${canComplete ? 
                                    `<button class="btn-success btn-small" onclick="completeAppointment(${apt.id})">Complete</button>` : 
                                    `<span style="color: #888; font-size: 12px;">Available on ${formatDate(apt.appointment_date)}</span>`
                                }
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderPastAppointments(appointments) {
            const tbody = document.getElementById('pastAppointmentsTableBody');
            if (!tbody) return;
            
            if (appointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888; padding: 40px;">No past appointments</td></tr>';
                return;
            }
            
            tbody.innerHTML = appointments.map((apt) => {
                let statusBadge = '';
                
                if (apt.status === 'Completed') {
                    statusBadge = '<span class="status-badge" style="background-color: #d1fae5; color: #065f46;">Completed</span>';
                } else if (apt.status === 'Rejected') {
                    statusBadge = '<span class="status-badge" style="background-color: #fee2e2; color: #991b1b;">Rejected</span>';
                } else if (apt.status === 'Approved') {
                    statusBadge = '<span class="status-badge" style="background-color: #fed7aa; color: #7c2d12;">Missed</span>';
                } else {
                    statusBadge = `<span class="status-badge">${escapeHtml(apt.status)}</span>`;
                }
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <strong>${escapeHtml(apt.patient_name)}</strong>
                            </div>
                        </td>
                        <td>${formatDate(apt.appointment_date)} ${apt.appointment_time}</td>
                        <td>${escapeHtml(apt.service_type)}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn-secondary btn-small" onclick="viewAppointmentDetails(${apt.id})">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function approveAppointment(id) {
            if (!confirm('Approve this appointment?')) return;
            
            try {
                const response = await fetch(`/api/doctor/appointment/approve/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('Appointment approved successfully!');
                    loadDoctorAppointments();
                } else {
                    alert(data.message || 'Failed to approve appointment');
                }
            } catch (error) {
                console.error('Error approving appointment:', error);
                alert('Failed to approve appointment. Please try again.');
            }
        }

        async function rejectAppointment(id) {
            if (!confirm('Are you sure you want to reject this appointment?')) return;
            
            try {
                const response = await fetch(`/api/doctor/appointment/reject/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('Appointment rejected');
                    loadDoctorAppointments();
                } else {
                    alert(data.message || 'Failed to reject appointment');
                }
            } catch (error) {
                console.error('Error rejecting appointment:', error);
                alert('Failed to reject appointment. Please try again.');
            }
        }

        async function completeAppointment(id) {
            if (!confirm('Mark this appointment as completed?')) return;
            
            try {
                const response = await fetch(`/api/doctor/appointment/complete/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('Appointment marked as completed');
                    loadDoctorAppointments();
                } else {
                    alert(data.message || 'Failed to complete appointment');
                }
            } catch (error) {
                console.error('Error completing appointment:', error);
                alert('Failed to complete appointment. Please try again.');
            }
        }

        async function viewAppointmentDetails(id) {
            try {
                const response = await fetch(`/api/doctor/appointment/${id}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const apt = data.data;
                    
                    const detailsText = `
        Appointment Details:

        Patient Name: ${apt.patient_name}
        Service Type: ${apt.service_type}
        Department: ${apt.department || 'N/A'}
        Doctor: ${apt.doctor}
        Date & Time: ${formatDate(apt.appointment_date)} ${apt.appointment_time}
        Reason: ${apt.reason}
        ${apt.room_type ? `Room Type: ${apt.room_type}` : ''}
        ${apt.duration ? `Duration: ${apt.duration} days` : ''}
        Status: ${apt.status}
        Created: ${apt.created_date}
                    `.trim();
                    
                    alert(detailsText);
                } else {
                    alert(data.message || 'Failed to load appointment details');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load appointment details');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }


        // OUT PATIENT MANAGEMENT - PULLS FROM APPOINTMENTS TABLE
        async function loadOutPatients() {
            console.log('[DEBUG] Loading out patients from appointments...');
            try {
                const response = await fetch('/api/doctor/outpatient-appointments');
                console.log('[DEBUG] Response status:', response.status);
                
                const data = await response.json();
                console.log('[DEBUG] Response data:', data);
                
                if (data.status === 'success') {
                    allOutPatients = data.data || [];
                    console.log('[DEBUG] Loaded out patient appointments:', allOutPatients.length);
                    renderOutPatients();
                } else {
                    console.error('[DEBUG] Failed to load out patients:', data.message);
                    showPatientError('outpatientsTableBody', data.message);
                }
            } catch (error) {
                console.error('[DEBUG] Error loading out patients:', error);
                showPatientError('outpatientsTableBody', 'Failed to load out patients. Please refresh the page.');
            }
        }



        function renderOutPatients() {
            const tbody = document.getElementById('outpatientsTableBody');
            if (!tbody) {
                console.error('[DEBUG] outpatientsTableBody not found!');
                return;
            }
            
            if (allOutPatients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888; padding: 40px;">No approved appointments for today</td></tr>';
                return;
            }
            
            tbody.innerHTML = allOutPatients.map((apt) => {
                return `
                    <tr>
                        <td><strong>${escapeHtml(apt.patient_name)}</strong></td>
                        <td>${formatDateTime(apt.appointment_date, apt.appointment_time)}</td>
                        <td>${escapeHtml(apt.service_type)}</td>
                        <td>${escapeHtml(apt.reason || '-')}</td>
                        <td><span class="status-badge" style="background-color: #d1fae5; color: #065f46;">Approved</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-success btn-small" onclick="openOutPatientMedicalRecords(${apt.id})">
                                    Medical Records
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }



        async function openOutPatientMedicalRecords(appointmentId) {
            console.log('[DEBUG] Opening out patient medical records for appointment ID:', appointmentId);
            
            // Store selected appointment ID
            sessionStorage.setItem('selectedAppointmentId', appointmentId);
            sessionStorage.setItem('patientType', 'outpatient');
            
            // Show the medical records page
            showSection('outPatientRecordsPage');
            
            // Load out patient data from appointment
            await loadOutPatientDataFromAppointment(appointmentId);
        }



        async function loadOutPatientDataFromAppointment(appointmentId) {
            try {
                console.log('[DEBUG] Loading out patient data for appointment ID:', appointmentId);
                
                // Show loading state
                document.getElementById('op-name').textContent = 'Loading...';
                document.getElementById('op-visit-date').textContent = 'Loading...';
                document.getElementById('op-service-type').textContent = 'Loading...';
                document.getElementById('op-doctor').textContent = 'Loading...';
                document.getElementById('op-specialty').textContent = 'Loading...';
                
                // Fetch appointment data with patient info
                const response = await fetch(`/api/doctor/outpatient-appointment/${appointmentId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    currentOutPatientData = data.data;
                    console.log('[DEBUG] Out patient data loaded:', currentOutPatientData);
                    
                    // Populate Patient Information section
                    document.getElementById('op-name').textContent = currentOutPatientData.patient_name || '-';
                    document.getElementById('op-visit-date').textContent = formatDateTime(currentOutPatientData.appointment_date, currentOutPatientData.appointment_time) || '-';
                    document.getElementById('op-service-type').textContent = currentOutPatientData.service_type || '-';
                    document.getElementById('op-reason').textContent = currentOutPatientData.reason || '-';
                    
                    // Populate Doctor section
                    document.getElementById('op-doctor').textContent = currentOutPatientData.doctor || '-';
                    document.getElementById('op-specialty').textContent = currentOutPatientData.doctor_specialty || '';
                    
                    // Update page title
                    document.getElementById('outPatientRecordsTitle').textContent = `Out Patient Records - ${currentOutPatientData.patient_name}`;
                    
                    // Update billing date
                    const billDate = document.getElementById('op-bill-date');
                    if (billDate) {
                        billDate.textContent = formatDate(currentOutPatientData.appointment_date);
                    }
                    
                } else {
                    console.error('[DEBUG] Failed to load out patient data:', data.message);
                    alert('Failed to load out patient data: ' + data.message);
                    showSection('outpatients');
                }
                
            } catch (error) {
                console.error('[DEBUG] Error loading out patient data:', error);
                alert('Failed to load out patient data. Please try again.');
                showSection('outpatients');
            }
        }




        function formatDateTime(dateString, timeString) {
            const formattedDate = formatDate(dateString);
            return `${formattedDate} ${timeString || ''}`;
        }

        function showPatientError(tableBodyId, message) {
            const tbody = document.getElementById(tableBodyId);
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #ef4444; padding: 40px;">${message}</td></tr>`;
            }
        }



        function switchOutPatientTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('#outPatientRecordsPage .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#outPatientRecordsPage .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Add active class to selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        async function filterOutPatientsByDate(date) {
            try {
                const response = await fetch(`/api/doctor/outpatient-appointments/filter?date=${date}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    allOutPatients = data.data || [];
                    renderOutPatients();
                } else {
                    showPatientError('outpatientsTableBody', data.message);
                }
            } catch (error) {
                console.error('Error filtering out patients:', error);
                showPatientError('outpatientsTableBody', 'Failed to filter out patients');
            }
        }


        async function loadAdmittedPatients() {
            console.log('[DEBUG] Loading admitted patients...');
            try {
                const response = await fetch('/api/doctor/admitted-patients');
                console.log('[DEBUG] Response status:', response.status);
                
                const data = await response.json();
                console.log('[DEBUG] Response data:', data);
                
                if (data.status === 'success') {
                    allAdmittedPatients = data.data || [];
                    console.log('[DEBUG] Loaded patients:', allAdmittedPatients.length);
                    renderAdmittedPatients();
                } else {
                    console.error('[DEBUG] Failed to load patients:', data.message);
                    showPatientError('patientsTableBody', data.message);
                }
            } catch (error) {
                console.error('[DEBUG] Error loading patients:', error);
                showPatientError('patientsTableBody', 'Failed to load patients. Please refresh the page.');
            }
        }

        function showPatientError(tableBodyId, message) {
            const tbody = document.getElementById(tableBodyId);
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #ef4444; padding: 40px;">${message}</td></tr>`;
            }
        }

        
        

        // Updated function to open Medical Records with patient data loading
        async function openMedicalRecords(patientId) {
            console.log('[DEBUG] Opening medical records for patient ID:', patientId);
            
            // Store selected patient ID
            sessionStorage.setItem('selectedPatientId', patientId);
            
            // Show the medical records page
            showSection('medicalRecordsPage');
            
            // Load patient data
            await loadPatientData(patientId);
        }

        async function loadPatientData(patientId) {
            try {
                console.log('[DEBUG] Loading patient data for ID:', patientId);
                
                // Show loading state
                document.getElementById('mr-name').textContent = 'Loading...';
                document.getElementById('mr-admission').textContent = 'Loading...';
                document.getElementById('mr-days').textContent = 'Loading...';
                document.getElementById('mr-room').textContent = 'Loading...';
                document.getElementById('mr-doctor').textContent = 'Loading...';
                document.getElementById('mr-specialty').textContent = 'Loading...';
                
                // Fetch patient admission data
                const response = await fetch(`/api/doctor/patient-admission/${patientId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    currentPatientData = data.data;
                    console.log('[DEBUG] Patient data loaded:', currentPatientData);
                    
                    // Populate Patient Information section
                    document.getElementById('mr-name').textContent = currentPatientData.patient_name || '-';
                    document.getElementById('mr-admission').textContent = formatDate(currentPatientData.admission_date) || '-';
                    document.getElementById('mr-days').textContent = currentPatientData.days_admitted || '0';
                    document.getElementById('mr-room').textContent = currentPatientData.room_type || '-';
                    
                    // Populate Attending Physician section
                    document.getElementById('mr-doctor').textContent = currentPatientData.doctor_name || '-';
                    // Use doctor_specialty from backend (fetched from Employee.department)
                    document.getElementById('mr-specialty').textContent = currentPatientData.doctor_specialty || '';
                    
                    // Update page title
                    document.getElementById('medicalRecordsTitle').textContent = `Medical Records - ${currentPatientData.patient_name}`;
                    
                } else {
                    console.error('[DEBUG] Failed to load patient data:', data.message);
                    alert('Failed to load patient data: ' + data.message);
                    showSection('patients'); // Go back to patient list
                }
                
            } catch (error) {
                console.error('[DEBUG] Error loading patient data:', error);
                alert('Failed to load patient data. Please try again.');
                showSection('patients'); // Go back to patient list
            }
        }

        function getDoctorSpecialty(doctorName) {
            // You can enhance this later to fetch from Employee table
            // For now, we'll extract from doctor name if it has specialty in parentheses
            // Or return a default specialty
            
            // Example: "Dr. Maria Santos (Internal Medicine)" -> "Internal Medicine"
            const match = doctorName.match(/\((.*?)\)/);
            if (match) {
                return match[1];
            }
            
            // Default specialty based on doctor name (you can customize this)
            return 'General Practice';
        }

        // Also update openPatientOrders to load patient data
        async function openPatientOrders(patientId) {
            console.log('[DEBUG] Opening patient orders for patient ID:', patientId);
            
            // Store selected patient ID
            sessionStorage.setItem('selectedPatientId', patientId);
            
            // Show the patient orders page
            showSection('patientOrdersPage');
            
            // Load patient data
            await loadPatientData(patientId);
            
            // Update page title
            if (currentPatientData) {
                document.getElementById('ordersPageTitle').textContent = `Patient Orders - ${currentPatientData.patient_name}`;
            }
        }

        function renderAdmittedPatients() {
            const tbody = document.getElementById('patientsTableBody');
            if (!tbody) {
                console.error('[DEBUG] patientsTableBody not found!');
                return;
            }
            
            if (allAdmittedPatients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888; padding: 40px;">No admitted patients found</td></tr>';
                return;
            }
            
            tbody.innerHTML = allAdmittedPatients.map((patient) => `
                <tr>
                    <td>
                        <strong>${escapeHtml(patient.patient_name)}</strong>
                    </td>
                    <td>${formatDate(patient.admission_date)}</td>
                    <td>${escapeHtml(patient.room_type)}</td>
                    <td>${patient.days_admitted || 0}</td>
                    <td><span class="status-badge" style="background-color: #d1fae5; color: #065f46;">Admitted</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-success btn-small" onclick="openMedicalRecords(${patient.id})">
                                Medical Records
                            </button>
                            <button class="btn-primary btn-small" onclick="openPatientOrders(${patient.id})">
                                Orders
                            </button>   
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function backToPatients() {
            showMainSection('patients');
        }



        // Messages functionality
        function loadConversation(conversationId) {
            // Remove active class from all conversations
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked conversation
            event.target.closest('.conversation-item').classList.add('active');
            
            // In a real app, you would load the actual conversation here
            console.log('Loading conversation:', conversationId);
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                // In a real app, you would send this to the server
                console.log('Sending message:', message);
                
                // Add message to chat (sample implementation)
                const messagesContainer = document.getElementById('messagesContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex';
                messageDiv.style.marginBottom = '16px';
                messageDiv.innerHTML = `
                    <div class="message-bubble message-sent">
                        <div>${message}</div>
                        <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                `;
                messagesContainer.appendChild(messageDiv);
                
                // Clear input
                input.value = '';
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function switchOrdersTab(tabName) {
            document.querySelectorAll('#patientOrdersPage .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#patientOrdersPage .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Tab switching for Medical Records page
        function switchMainTab(tabName) {
            document.querySelectorAll('#medicalRecordsPage .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#medicalRecordsPage .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }


        document.addEventListener('DOMContentLoaded', function() {
        // Load appointments
        loadDoctorAppointments();
        
        // Initialize BOTH billing containers with complete billing data including totals
        const billItemsHTML = `
            <div class="bill-section-header">Admissions</div>
            <div class="bill-item">
                <div class="bill-item-info">
                    <div class="bill-item-name">Admission Fee</div>
                    <div class="bill-item-date">1/30/2026</div>
                </div>
                <div class="bill-item-amount">‚Ç±1,000</div>
            </div>

            <div class="bill-section-header">Doctors</div>
            <div class="bill-item">
                <div class="bill-item-info">
                    <div class="bill-item-name">Professional Fee - Dr. Maria Santos (Internal Medicine)</div>
                    <div class="bill-item-date">1/30/2026</div>
                </div>
                <div class="bill-item-amount">‚Ç±1,500</div>
            </div>

            <div class="bill-total">
                <div class="bill-total-row">
                    <div class="bill-total-label">Subtotal:</div>
                    <div style="font-size: 18px; font-weight: 600; color: var(--foreground);">‚Ç±2,500</div>
                </div>
                <div class="bill-total-row">
                    <div class="bill-total-label">Payments Made:</div>
                    <div style="font-size: 18px; font-weight: 600; color: #22c55e;">-‚Ç±0</div>
                </div>
                <div class="bill-total-row" style="padding-top: 12px; border-top: 1px solid var(--border); margin-top: 8px;">
                    <div class="bill-total-label" style="font-size: 18px;">Balance Due:</div>
                    <div class="bill-total-amount">‚Ç±2,500</div>
                </div>
            </div>
        `;
        
        // Set for Medical Records > Billing tab
        const treatmentBillContainer = document.getElementById('treatmentBillItemsList');
        if (treatmentBillContainer) {
            treatmentBillContainer.innerHTML = billItemsHTML;
        }
        
        // Set for Patient Orders > Running Bill tab
        const billContainer = document.getElementById('billItemsList');
        if (billContainer) {
            billContainer.innerHTML = billItemsHTML;
        }
    });

        function updateBillingTotals() {
            // This function can be called whenever a new item is added to the bill
            // For now, it just updates both billing displays with fresh data
            
            const billItemsHTML = `
                <div class="bill-section-header">Admissions</div>
                <div class="bill-item">
                    <div class="bill-item-info">
                        <div class="bill-item-name">Admission Fee</div>
                        <div class="bill-item-date">1/30/2026</div>
                    </div>
                    <div class="bill-item-amount">‚Ç±1,000</div>
                </div>

                <div class="bill-section-header">Doctors</div>
                <div class="bill-item">
                    <div class="bill-item-info">
                        <div class="bill-item-name">Professional Fee - Dr. Maria Santos (Internal Medicine)</div>
                        <div class="bill-item-date">1/30/2026</div>
                    </div>
                    <div class="bill-item-amount">‚Ç±1,500</div>
                </div>

                <div class="bill-total">
                    <div class="bill-total-row">
                        <div class="bill-total-label">Subtotal:</div>
                        <div style="font-size: 18px; font-weight: 600; color: var(--foreground);">‚Ç±2,500</div>
                    </div>
                    <div class="bill-total-row">
                        <div class="bill-total-label">Payments Made:</div>
                        <div style="font-size: 18px; font-weight: 600; color: #22c55e;">-‚Ç±0</div>
                    </div>
                    <div class="bill-total-row" style="padding-top: 12px; border-top: 1px solid var(--border); margin-top: 8px;">
                        <div class="bill-total-label" style="font-size: 18px;">Balance Due:</div>
                        <div class="bill-total-amount">‚Ç±2,500</div>
                    </div>
                </div>
            `;
            
            const treatmentBillContainer = document.getElementById('treatmentBillItemsList');
            if (treatmentBillContainer) {
                treatmentBillContainer.innerHTML = billItemsHTML;
            }
            
            const billContainer = document.getElementById('billItemsList');
            if (billContainer) {
                billContainer.innerHTML = billItemsHTML;
            }
        }














        // Order type selection
        function selectOrderType(type) {
            const serviceSelect = document.getElementById('serviceSelect');
            serviceSelect.innerHTML = '<option value="">-- Select Service --</option>';
            
            if (type === 'laboratory') {
                serviceSelect.innerHTML += `
                    <option value="cbc">Complete Blood Count - ‚Ç±500</option>
                    <option value="urinalysis">Urinalysis - ‚Ç±300</option>
                    <option value="xray">Chest X-Ray - ‚Ç±800</option>
                    <option value="ecg">ECG - ‚Ç±600</option>
                `;
            } else if (type === 'pharmacy') {
                serviceSelect.innerHTML += `
                    <option value="paracetamol">Paracetamol 500mg - ‚Ç±50</option>
                    <option value="amoxicillin">Amoxicillin 500mg - ‚Ç±150</option>
                    <option value="ibuprofen">Ibuprofen 400mg - ‚Ç±75</option>
                `;
            } else if (type === 'procedures') {
                serviceSelect.innerHTML += `
                    <option value="wound-dressing">Wound Dressing - ‚Ç±500</option>
                    <option value="iv-insertion">IV Insertion - ‚Ç±300</option>
                `;
            }
        }

        // Add order to bill
        function addOrderToBill() {
            const serviceSelect = document.getElementById('serviceSelect');
            if (!serviceSelect.value) {
                alert('Please select a service first');
                return;
            }
            alert('‚úÖ Order added to bill successfully!');
        }

        // Add hospital day
        function addHospitalDay() {
            if (confirm('Add hospital day charge to the bill?')) {
                alert('‚úÖ Hospital day added successfully!');
            }
        }

        // Add hospital day from treatment page
        function addHospitalDayFromTreatment() {
            addHospitalDay();
        }

        // Medical Records Functions
        function saveVitalSigns() {
            alert('‚úÖ Vital signs saved successfully!');
        }

        function addAllergy() {
            alert('‚úÖ Allergy added successfully!');
        }

        function addCurrentMedication() {
            alert('‚úÖ Medication added successfully!');
        }

        function saveComplaint() {
            alert('‚úÖ Presenting complaint saved successfully!');
        }

        function saveHistory() {
            alert('‚úÖ History and examination saved successfully!');
        }

        function addDiagnosis() {
            alert('‚úÖ Diagnosis added successfully!');
        }

        function addInvestigation() {
            alert('‚úÖ Investigation ordered successfully!');
        }

        function addPrescription() {
            alert('‚úÖ Prescription added successfully!');
        }

        function saveAdvice() {
            alert('‚úÖ Advice saved successfully!');
        }

        function generateCertificate() {
            alert('‚úÖ Medical certificate generated successfully!');
        }

        function saveReferral() {
            alert('‚úÖ Referral saved successfully!');
        }

        function updateFinalBalance() {
            console.log('Updating final balance...');
        }

        function processDischarge() {
            if (confirm('Process patient discharge? This action cannot be undone.')) {
                alert('‚úÖ Patient discharged successfully!');
                showSection('patients');
            }
        }

        function showPage(pageName) {
            showSection(pageName);
        }
                

        async function logout() {
            if (!confirm('Are you sure you want to logout?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    window.location.href = data.redirect;
                }
            } catch (err) {
                console.error('Logout error:', err);
                window.location.href = '/IMS';
            }
        }


    </script>
</body>
</html>